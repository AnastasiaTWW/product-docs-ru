# Рекомендации по установке и поддержке Валарм WAF

В данном документе сформулированы рекомендации по установке и поддержке компонентов Валарм WAF.

## Изучите возможности NGINX

Основной компонент Валарм WAF — WAF‑нода, которая устанавливается в вашу инфраструктуру. В большинстве форм установок, WAF‑нода использует NGINX в качестве обратного прокси‑сервера.

NGINX — надежный и производительный сервер, который предоставляет широкий набор возможностей и модулей. Чтобы познакомиться с NGINX и его возможностями, мы рекомендуем обратиться к следующим публичным статьям на английском языке:

* [Awesome NGINX](https://github.com/agile6v/awesome-nginx)
* [NGINX: Basics and Best Practices slide show](https://www.slideshare.net/Nginx/nginx-basics-and-best-practices-103340015)
* [How to optimize NGINX configuration](https://www.digitalocean.com/community/tutorials/how-to-optimize-nginx-configuration)
* [3 quick steps to optimize the performance of your NGINX server](https://www.techrepublic.com/article/3-quick-steps-to-optimize-the-performance-of-your-nginx-server/)
* [How to Build a Tough NGINX Server in 15 Steps](https://www.upguard.com/blog/how-to-build-a-tough-nginx-server-in-15-steps)
* [How to Tune and Optimize Performance of NGINX Web Server](https://hostadvice.com/how-to/how-to-tune-and-optimize-performance-of-nginx-web-server/)
* [Powerful ways to supercharge your NGINX server and improve its performance](https://www.freecodecamp.org/news/powerful-ways-to-supercharge-your-nginx-server-and-improve-its-performance-a8afdbfde64d/)
* [TLS Deployment Best Practices](https://www.linode.com/docs/guides/tls-deployment-best-practices-for-nginx/)
* [NGINX Web Server Security and Hardening Guide](https://geekflare.com/nginx-webserver-security-hardening-guide/)
* [NGINX Tuning For Best Performance](https://github.com/denji/nginx-tuning)
* [Top 25 NGINX Web Server Best Security Practices](https://www.cyberciti.biz/tips/linux-unix-bsd-nginx-webserver-security.html)

## Следуйте рекомендованному процессу при изучении продукта

1. Изучите возможные [формы установки WAF‑ноды](../admin-ru/supported-platforms.md).
2. Если требуется, изучите способы [настройки WAF‑ноды для изолированных сред](../admin-ru/configuration-guides/waf-in-separated-environments/configure-waf-in-separated-environments.md).
3. Разверните WAF‑ноду в [режиме фильтрации](../admin-ru/configure-wallarm-mode.md) `monitoring` в среде разработки или тестирования.
4. Изучите механизм работы, способы масштабирования и мониторинга WAF‑ноды и убедитесь в стабильности нового компонента системы.
5. Разверните WAF‑ноду в [режиме фильтрации](../admin-ru/configure-wallarm-mode.md) `monitoring` в боевой среде.
6. Настройте процессы обновления и [мониторинга](#настройте-мониторинг-развернутых-wafнод) WAF‑ноды.
7. Сохраните движение запросов через WAF‑ноды в течение 7-14 дней во всех средах, включая тестовую и боевую. Это позволит Облаку Валарм более качественно проанализировать ваше приложение и входящие запросы.
8. Переведите WAF‑ноду в [режим фильтрации](../admin-ru/configure-wallarm-mode.md) `block` в среде разработки или тестирования и убедитесь, что это не повлияло на работу защищаемого ресурса, используя ручные или автоматизированные тесты.
9. Переведите WAF‑ноду в [режим фильтрации](../admin-ru/configure-wallarm-mode.md) `block` в боевой среде и убедитесь, что это не повлияло на работу защищаемого ресурса, используя ручные или автоматизированные тесты.

## Разверните WAF‑ноду в тестовой и в боевой средах

В большинстве случаев количество WAF‑нод, которые может установить клиент, не ограничено. Поэтому мы рекомендуем развернуть и использовать WAF‑ноду во всех средах вашей инфраструктуры: в боевой и тестовой средах, среде разработки и т.д.

Анализ запросов к приложению на всех этапах его разработки и публикации позволяет составить более точный профиль приложения и минимизировать риск непредвиденного поведения WAF‑ноды в боевой среде.

## Настройте корректную передачу IP‑адреса источника запросов

Если перед передачей на WAF‑ноду запросы проходят через прокси‑сервер или балансировщик нагрузки, в качестве IP‑адреса источника запросов на WAF‑ноду передается адрес прокси-сервера или балансировщика. В этом случае [блокировка IP‑адресов (добавление в черный список)](../admin-ru/configure-ip-blocking-ru.md), [Активная проверка атак](detecting-vulnerabilities.md#перепроверка-атак) и некоторые другие возможности Валарм WAF могут работать некорректно.

Чтобы настроить корректную передачу IP‑адреса источника на WAF‑ноду, используйте следующие инструкции:

* [Инструкция для WAF‑ноды на основе NGINX](../admin-ru/using-proxy-or-balancer-ru.md) (в том числе для образов AWS / GCP / Яндекс.Облака, Docker-контейнера и sidecar-контейнеров Kubernetes)
* [Инструкция для Ingress-контроллера Валарм в Kubernetes](../admin-ru/configuration-guides/wallarm-ingress-controller/best-practices/report-public-user-ip.md)

## Добавьте IP‑адреса Сканера Валарм в белый список

Чтобы WAF‑нода не блокировала запросы, которые [модуль активной проверки атак](detecting-vulnerabilities.md#перепроверка-атак) и [Сканер уязвимостей](detecting-vulnerabilities.md#сканер-уязвимостей) отправляют на адрес приложения для обнаружения уязвимостей, необходимо отключить блокировку IP‑адресов Сканера Валарм. Чтобы добавить IP‑адреса в белый список, используйте следующие инструкции:

* [Инструкция для WAF‑ноды на основе NGINX](../admin-ru/scanner-ips-whitelisting.md) (в том числе для образов AWS / GCP / Яндекс.Облака и Docker-контейнера)
* [Инструкция для Ingress-контроллера Валарм в Kubernetes](../admin-ru/configuration-guides/wallarm-ingress-controller/best-practices/whitelist-wallarm-ip-addresses.md)
* Инструкция для sidecar-контейнера Валарм, развернутного в Kubernetes с помощью [Helm charts](../admin-ru/installation-guides/kubernetes/wallarm-sidecar-container-helm.md) или [Kubernetes-манифестов](../admin-ru/installation-guides/kubernetes/wallarm-sidecar-container-manifest.md)

Если IP‑адреса Сканера Валарм не добавлены в белый список, [модуль активной проверки атак](detecting-vulnerabilities.md#перепроверка-атак) и [Сканер уязвимостей](detecting-vulnerabilities.md#сканер-уязвимостей) могут работать некорректно.

## Настройте мониторинг развернутых WAF‑нод

Одна из рекомендуемых настроек WAF‑ноды — качественный мониторинг ее работы. Вместе с каждой WAF‑нодой Валарм установлен сервис `collectd`, который собирает [метрики](../admin-ru/monitoring/available-metrics.md) по состоянию WAF‑ноды и проанализированным запросам.

Способ для настройки мониторинга WAF‑ноды зависит от формы ее установки:

* [Инструкция для WAF‑ноды на основе NGINX](../admin-ru/monitoring/intro.md) (в том числе для образов AWS / GCP / Яндекс.Облака и sidecar-контейнеров Kubernetes)
* [Инструкция для Ingress-контроллера Валарм в Kubernetes](../admin-ru/configuration-guides/wallarm-ingress-controller/best-practices/ingress-controller-monitoring.md)
* [Инструкция для Docker-образа на основе NGINX](../admin-ru/installation-docker-ru.md#настройка-мониторинга)

## Настройте схему резервирования защищаемого ресурса

Как и установка любого компонента в боевой среде, установка WAF‑ноды должна быть правильно спроектирована и произведена с учетом случаев, когда WAF‑нода может оказаться неработоспособной (например, из‑за отключения питания). Для высокой доступности WAF‑ноды, необходимо использовать **минимум две WAF‑ноды** для обработки основного трафика ресурса и настроить схему резервирования, используя следующие инструкции:

* [Инструкция для WAF‑ноды на основе NGINX](../admin-ru/configure-backup-ru.md) (в том числе для образов AWS / GCP / Яндекс.Облака, Docker-контейнера и sidecar-контейнеров Kubernetes)
* [Инструкция для Ingress-контроллера Валарм в Kubernetes](../admin-ru/configuration-guides/wallarm-ingress-controller/best-practices/high-availability-considerations.md)

## Включите блокировку запросов по IP‑адресам

Помимо блокировки запросов с признаками атаки, WAF‑нода Валарм может блокировать IP‑адреса источников запросов (добавлять в черный список). По умолчанию блокировка IP‑адресов отключена.

Мы рекомендуем включить блокировку запросов по IP‑адресам после знакомства с основными возможностями Валарм WAF и переключения WAF‑ноды из режиме мониторинга в режим блокировки. Для включения блокировки IP‑адресов используйте следующие инструкции:

* [Инструкция для WAF‑ноды на основе NGINX](../admin-ru/configure-ip-blocking-nginx-ru.md) (в том числе для образов AWS / GCP / Яндекс.Облака и sidecar-контейнеров Kubernetes)
* [Инструкция для Ingress-контроллера Валарм в Kubernetes](../admin-ru/configuration-guides/wallarm-ingress-controller/best-practices/block-ip-addresses.md)
* Для Docker-образа на основе NGINX необходимо передать переменную окружения `WALLARM_ACL_ENABLE=true` при запуске контейнера ([более подробная инструкция](../admin-ru/installation-docker-ru.md))

После включения блокировки запросов по IP‑адресам, вы можете выполнить следующие полезные настройки Валарм WAF с помощью [триггеров](../user-guides/triggers/triggers.md):

* [Блокировка источника запросов, с которого поступило большое количество атак за определенный период](../user-guides/triggers/trigger-examples.md#блокировка-ip-при-4-и-более-векторах-атак-за-3-часа-триггер-по-умолчанию)
* [Защита от брутфорса](../admin-ru/configuration-guides/protecting-against-bruteforce.md)

## Изучите способы низкоуровневой конфигурации WAF‑ноды

* Применяйте стандартные процессы управления настройками DevOps-компонентов для низкоуровневой конфигурации WAF‑ноды.
* Настраивайте правила обработки трафика конкретных приложений, задавая разные [ID приложений](../admin-ru/configure-parameters-ru.md#wallarm_instance) или значения заголовка `Host`.
* Помимо применения правила [Считать атакой на основе регулярного выражения](../user-guides/rules/regex-rule.md#добавление-нового-правила-детекта) к конкретному приложению, вы можете использовать это правило в экспериментальном режиме, или когда WAF‑нода работает в режиме мониторинга.
* Используйте правило [Установить режим фильтрации](../user-guides/rules/wallarm-mode-rule.md) для изменения режима фильтрации в конкретных средах и запросах. Данное правило позволяет более гибко настроить способ защиты новых эндпоинтов и других ресурсов в разных средах. По умолчанию, используется значение [`wallarm_mode`](../admin-ru/configure-parameters-ru.md#wallarm_mode) в зависимости от настройки [`wallarm_mode_allow_override`](../admin-ru/configure-parameters-ru.md#wallarm_mode_allow_override).

## Настройте интеграции со сторонними системами для уведомлений о событиях

Чтобы оперативно получать уведомления о событиях безопасности в вашей системе, вы можете настроить [нативные интеграции](../user-guides/settings/integrations/integrations-intro.md) с PagerDuty, Slack, Opsgenie, Telegram и другими системами. Например, в системы отправляются следующие уведомления:

* Новые уязвимости, обнаруженные в защищаемом приложении
* Изменения в сетевом периметре компании
* Новые пользователи аккаунта компании в Консоли управления Валарм и т.д.

Для более тонкой настройки уведомлений вы также можете использовать [Триггеры](../user-guides/triggers/triggers.md). 

## Изучите возможности Триггеров

В зависимости от особенностей ваших приложений, мы рекомендуем изучить следующие возможности [триггеров](../user-guides/triggers/triggers.md):

* Мониторинг роста в числе вредоносных запросов, обнаруженных WAF‑нодой. Данный триггер может сигнализировать о следующих потенциальных проблемах:

    * На приложение выполняется атака, и Валарм WAF успешно блокирует вредоносные запросы. При получении соответствующего уведомления, вы можете проверить обнаруженные атаки в Консоли управления Валарм и вручную заблокировать IP‑адреса источников запросов.
    * Растет количество ложных срабатываний. В этом случае вы можете сообщить о проблеме в [техническую поддержку Валарм](mailto:support@wallarm.ru) или [отметить атаки как ложные срабатывания вручную](../user-guides/events/false-attack.md).
    * Если вы настроили блокировку запросов по IP‑адресам и [триггер по умолчанию](../user-guides/triggers/trigger-examples.md#блокировка-ip-при-4-и-более-векторах-атак-за-3-часа-триггер-по-умолчанию) включен, но количество вредоносных запросов продолжает расти, в настройках блокировки IP‑адресов или триггера может быть допущена ошибка.

    [Пример настроенного триггера →](../user-guides/triggers/trigger-examples.md#уведомление-в-slack-при-2-и-более-хитах-sqli-за-1-минуту)
* Уведомление о новом пользователе, добавленном в аккаунт компании в Консоли управления Валарм

    [Пример настроенного триггера →](../user-guides/triggers/trigger-examples.md#уведомления-на-email-и-в-slack-при-добавлении-пользователя)
* Отметить запрос как дирбаст или брутфорс-атаку и заблокировать IP‑адреса источников запросов

    [Инструкция по настройке защиты от брутфорса →](../admin-ru/configuration-guides/protecting-against-bruteforce.md)
* Уведомление о блокировке нового IP‑адреса

    [Пример настроенного триггера →](../user-guides/triggers/trigger-examples.md#отправка-вебхука-при-добавлении-ipадреса-в-черный-список)

## Включите SSO для аккаунта вашей компании в Консоли управления Валарм

Вы можете использовать технологию единого входа (Single Sign‑On, SSO) для аутентификации пользователей вашей компании в Консоли управления Валарм. В качестве провайдера SSO может использоваться G Suite, Okta, OneLogin или любой другой провайдер.

Для включения SSO, свяжитесь с вашим аккаунт-менеджером Валарм или технической поддержкой Валарм и после этого выполните настройку SSO по [инструкции](../admin-ru/configuration-guides/sso/intro.md).

## Используйте Terraform-провайдер Валарм для управления конфигурацией Облака Валарм

С помощью [официального Terraform-провайдера Валарм](https://registry.terraform.io/providers/wallarm/wallarm/latest) вы можете управлять конфигурацией Облака Валарм, а именно: списком ползователей, приложений, интеграций и т.д.

## Включите в план оперативное обновление WAF‑ноды до новых версий

Мы непрерывно повышаем качество продукта Валарм WAF и выпускаем новые версии с улучшениями. Новые версии публикуются примерно раз в квартал. Более детальная информация о процессе обновления и возможных рисках приведена в документе с [рекомендациями по обновлению WAF‑ноды](../updating-migrating/general-recommendations.md).

## Ознакомьтесь с известными ограничениями продукта

* Все WAF‑ноды, прикрепленные к одному аккаунту Валарм, получают из Облака Валарм одинаковый набор правил. Вы можете применить разные правила к разным приложениям, задав ID приложений или уникальные элементы HTTP-запросов (например, заголовки) в настройках правил.
* Если в Консоли управления Валарм настроен триггер, который блокирует IP‑адреса (например, [триггер по умолчанию](../user-guides/triggers/trigger-examples.md#блокировка-ip-при-4-и-более-векторах-атак-за-3-часа-триггер-по-умолчанию)), IP‑адрес будет заблокирован для всех приложений. Блокировка IP‑адресов (добавление в черный список) настраивается на уровне WAF‑ноды и защищаемого ресурса с помощью [локальных настроек NGINX](../admin-ru/configure-ip-blocking-nginx-ru.md).

## Следуйте рекомендациям по управлению модулем активной проверки атак

Один из методов [обнаружения уязвимостей](../about-wallarm-waf/detecting-vulnerabilities.md) — **Активная проверка атак**. Модуль активной проверки атак воспроизводит атаки из реального трафика, обработанного WAF‑нодой, и анализирует ответ приложения на наличие признаков уязвимостей, которые потенциально могли быть проэксплуатированы.

[Изучить рекомендации по управлению модулем активной проверки атак →](../admin-ru/attack-rechecker-best-practices.md)
