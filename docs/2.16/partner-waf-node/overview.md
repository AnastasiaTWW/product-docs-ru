# Обзор партнерской схемы работы

## Определение партнера и партнерской WAF‑ноды

**Партнер** — организация, которая устанавливает WAF‑ноду в инфраструктуру своей системы и распространяет систему с WAF‑нодой среди собственных клиентов.

**Партнерская WAF‑нода** — WAF‑нода, которую установил партнер.

## Схема обработки трафика партнерской WAF‑нодой

Если в инфраструктуре партнера установлена одна партнерская WAF‑нода, трафик клиентов обрабатывается по следующей схеме:

![!Трафик на партнерской схеме](../images/partner-waf-node/partner-traffic-processing.png)

* Одна WAF‑нода обрабатывает трафик нескольких клиентов (Client 1, Client 2).
* WAF‑нода определяет клиента, которому поступает трафик, по ID связи "партнер‑клиент" (`wallarm_instance`).
* Для доменов `https://client1.com` и `https://client2.com` настроена A‑запись DNS с IP‑адресом партнера: `225.130.128.241`. Данная настройка приведена в качестве примера, на стороне партнера и клиента может использоваться другая настройка.
* На стороне партнера настроено проксирование легитимных запросов на адреса клиентов Client 1 и Client 2: `http://upstream1:8080` и `http://upstream2:8080` соответственно. Данная настройка приведена в качестве примера, на стороне партнера и клиента может использоваться другая настройка.

Если в инфраструктуре партнера установлено несколько партнерских WAF‑нод, трафик клиента обрабатывается аналогичным образом, но на нескольких серверах партнера.

## Партнерский аккаунт

### Особенности партнерского аккаунта

Для работы с партнерами, Валарм поддерживает специальные партнерские аккаунты. Партнер с партнерским аккаунтом может:

* Установить партнерскую WAF‑ноду (или несколько WAF‑нод) в инфраструктуру своей системы и задать настройки для обработки трафика клиентов
* Создать отдельные аккаунты для клиентов в Консоли управления и предоставить клиентам доступ к аккаунтам
* Брендировать Консоль управления и выбрать язык интерфейса Консоли управления (английский или русский)
* Разместить Консоль управления на своем домене
* Брендировать клиентские письма и отчеты
* Задать адрес своей технической поддержки для получения обращений от клиентов

В зависимости от плана подписки на Валарм WAF, некоторые возможности могут быть недоступны.

### Компоненты партнерского аккаунта

**Партнерский аккаунт** включает в себя несколько компонентов:

* **Аккаунт технического клиента** для доступа пользователей партнера к Консоли управления, для добавления [глобальных пользователей](../user-guides/settings/users.md#роли-пользователей) партнера.
* **Аккаунты партнерских клиентов** для доступа [глобальных пользователей](../user-guides/settings/users.md#роли-пользователей) партнера и пользователей клиента к Консоли управления, для установки ID связи "партнер‑клиент" (`wallarm_instance`).

![!Схема аккаунтов на партнерской схеме](../images/partner-waf-node/accounts-scheme.png)

При аутентификации [глобального пользователя](../user-guides/settings/users.md#роли-пользователей) партнера в Консоли управления, все компоненты партнерского аккаунта будут визуально представлены в Консоли управления Валарм. Например:

![!Селектор клиентов в Консоли управления](../images/partner-waf-node/clients-selector-in-console.png)

* `Demo partner` — партнерский аккаунт
* `Technical client` — аккаунт технического клиента
* `Client 1` и `Client 2` — аккаунты партнерских клиентов

## Особенности партнерской WAF‑ноды

Партнерская WAF‑нода имеет следующие особенности:

* Устанавливается на те же платформы и по тем же инструкциям, что и обычная WAF‑нода:

    --8<-- "../include/waf/installation/supported-platforms-216.md"
* Может быть установлена на уровне **технического клиента** или на уровне **партнерского клиента**. Если необходимо предоставить клиенту доступ к Консоли управления, WAF‑нода должна быть установлена на уровне соответствующего партнерского клиента.
* Настраивается по инструкциям для обычной WAF‑ноды, за исключением:
    * Директива [`wallarm_instance`](../admin-ru/configure-parameters-ru.md#wallarm_instance) используется для разделения по приложениям клиентов партнера.
    * Чтобы включить блокировку запросов по IP‑адресам, необходимо отправить запрос в [техническую поддержку Валарм](mailto:support@wallarm.ru). После этого, для блокировки IP‑адресов необходимо добавлять их в черный список на уровне соответствующих аккаунтов партнерских клиентов.

## Как стать партнером и установить партнерскую WAF‑ноду

Чтобы стать партнером Валарм и установить партнерскую WAF‑ноду в свою инфраструктуру:

1. [Создайте](creating-partner-account.md) партнерский аккаунт в системе Валарм.
2. [Создайте и привяжите](connecting-clients.md) клиентов.
3. [Установите и настройте](installing-partner-waf-node.md) партнерскую WAF‑ноду.
