[link-ssh-keys]:            https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/get-set-up-for-amazon-ec2.html#create-a-key-pair
[link-sg]:                  https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/get-set-up-for-amazon-ec2.html#create-a-base-security-group
[link-launch-instance]:     https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html#ec2-launch-instance

[anchor1]:      #3-создание-группы-безопасности
[anchor2]:      #2-создание-ssh-ключей

[img-create-sg]:                ../images/installation-ami/common/create_sg.png

# Развертывание с Amazon Machine Image

Развертывание WAF‑ноды с Amazon Machine Image (AMI) включает в себя следующие шаги:

1. Вход в учетную запись Amazon Web Services.
2. Создание SSH-ключей.
3. Создание группы безопасности.
4. Запуск инстанса с WAF‑нодой.
5. Подключение по SSH к инстансу с WAF‑нодой.
6. Подключение WAF‑ноды к облаку Валарм.
7. Настройка WAF‑ноды для использования прокси‑сервера.
8. Настройка правил проксирования и фильтрации.
9. Настройка выделения оперативной памяти для WAF‑ноды.
10. Настройка логирования.  
11. Перезапуск NGINX.

   

##  1.  Вход в учетную запись Amazon Web Services

Войдите в [aws.amazon.com](https://aws.amazon.com/).

##  2.  Создание SSH-ключей 

В ходе процесса развертывания вы должны будете подключиться к виртуальной машине по протоколу SSH. Amazon EC2 позволяет создать именованную пару из открытого и закрытого SSH-ключей, которые затем могут использоваться для подключения к инстансу. 

Для того, чтобы создать пару ключей:
1.  Перейдите на вкладку *Key pairs* в дашборде Amazon EC2.
2.  Нажмите на кнопку *Create Key Pair*.
3.  Введите желаемое имя пары ключей и нажмите *Create*.

Загрузка файла приватного SSH-ключа в формате PEM начнется автоматически. Сохраните его для подключения к создаваемому инстансу в будущем.

!!! info "Создание SSH-ключей"
    Более подробную информацию о создании ключей можно получить [здесь][link-ssh-keys].

##  3.  Создание группы безопасности

Группа безопасности (Security Group) определяет перечень разрешенных и запрещенных входящих и исходящих соединений для виртуальных машин. Итоговый перечень определяется в зависимости от защищаемого приложения (например, можно открыть все входящие соединения к стандартным портам TCP/80 и TCP/443).

!!! warning "Правила для исходящих соединений в группе безопасности"
    По умолчанию при создании группы безопасности открыты все исходящие соединения. Если вы ограничиваете исходящие соединения от WAF‑ноды, убедитесь, что ему предоставлен доступ к серверу Валарм API. Адрес сервера зависит от облака, которое вы используете:
    
    * `api.wallarm.com:444` для EU‑облака
    * `api.wallarm.ru:444` для RU‑облака
    
    Это необходимо для корректной работы WAF‑ноды.

Создайте группу безопасности для WAF‑ноды. Для этого выполните следующие действия:
1.  Перейдите на вкладку *Security Groups* в дашборде Amazon EC2 и нажмите на кнопку *Create Security Group*.
2.  В появившемся диалоговом окне введите имя группы безопасности и опциональное описание.
3.  Выберите необходимую вам VPC.
4.  Настройте входящие и исходящие правила на вкладках *Inbound* и *Outbound*.
5.  Нажмите на кнопку *Create* для создания группы безопасности.

![!Создание группы безопасности][img-create-sg]

Более подробную информацию о создании группы безопасности можно получить [здесь][link-sg].

##  4.  Запуск инстанса с WAF‑нодой

!!! info "Если Валарм WAF уже установлен"
    Если вы запускаете инстанс вместо существующего Валарм WAF или дублируете инстанс, используйте версию существующего Валарм WAF или обновите версии всех инстансов до последней.

    Чтобы получить текущую версию, используйте команду: 

    ```
    apt list wallarm-node
    ```

    * Если установлена версия `2.18.x`, используйте текущую инструкцию.
    * Если установлена версия `2.16.x`, используйте [инструкцию для 2.16](../../2.16/admin-ru/installation-ami-ru/) или обновите все инстансы Валарм WAF до 2.18.
    * Если установлена версия `2.14.x` или ниже, обновите все инстансы Валарм WAF до 2.18.

    Более подробная информация о поддержке версий доступна в [политике версионирования WAF‑ноды](../updating-migrating/versioning-policy.md).

Перейдите в [Amazon Marketplace](https://aws.amazon.com/marketplace/pp/B073VRFXSD) и запустите инстанс с WAF‑нодой версии 2.18.0.

При создании инстанса необходимо указать созданную Вами [ранее][anchor1] группу безопасности. Для этого:
1.  Находясь в Launch Instance Wizard, перейдите на шаг запуска инстанса *6. Configure Security Group*, нажав на соответствующую вкладку.
2.  Выберите «Select an existing security group» в опции *Assign a security group*.
3.  В появившемся списке выберите группу безопасности.

После введения всех необходимых настроек инстанса, нажмите на кнопку *Review and Launch*, проверьте, что инстанс настроен корректно, и нажмите на кнопку *Launch*.

В появившемся окне укажите созданную Вами [ранее][anchor2] пару ключей:
1.  В первом выпадающем списке выберите пункт «Choose an existing key pair».
2.  Во втором выпадающем списке выберите имя пары ключей.
3.  Убедитесь в том, что вы имеете доступ к приватному ключу в формате PEM из той пары ключей, которую Вы указали во втором выпадающем списке, и поставьте галочку, подтверждающую это.
4.  Нажмите *Launch Instances*.

Инстанс запустится с предустановленной WAF‑нодой.

Подробнее о запуске инстансов в AWS вы можете узнать [здесь][link-launch-instance].

##  5.  Подключение по SSH к инстансу с WAF‑нодой

Необходимо подключаться к инстансу, используя имя пользователя «admin».

!!! info "Использование ключа для SSH-подключения"
    Для подключения к инстансу по SSH необходимо использовать приватный ключ в формате PEM, который Вы создали [ранее][anchor2]. Используйте приватный ключ из той пары SSH-ключей, имя которой вы указали при создании инстанса.

Подробнее о способах подключения к инстансу вы можете узнать [здесь](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html).

##  6.  Подключение WAF‑ноды к облаку Валарм

--8<-- "../include/connect-cloud-node-cloud-ru-2.16.md"

##  7.  Настройка WAF‑ноды для использования прокси‑сервера

--8<-- "../include/setup-proxy.md"

##  8.  Настройка правил проксирования и фильтрации

--8<-- "../include/setup-filter-nginx-ru.md"

##  9.  Настройка выделения оперативной памяти для WAF‑ноды

WAF‑нода использует находящееся в памяти хранилище Tarantool.

По умолчанию развернутый образ WAF‑ноды Валарм выделяет под Tarantool 40% от общей памяти инстанса.

Вы можете изменить это значение.

Укажите объем оперативной памяти для Tarantool:

1. Откройте для редактирования конфигурационный файл Tarantool:

    ``` bash
    sudo vim /etc/default/wallarm-tarantool
    ```

2. Укажите размер выделенной памяти в директиве `SLAB_ALLOC_ARENA` в ГБ. Значение может быть целым или дробным (разделитель целой и дробной части — точка). Например, 24 ГБ:
    ``` bash
    SLAB_ALLOC_ARENA=24
    ```

3. Чтобы применить сделанные изменения, перезапустите Tarantool:

    ``` bash
    sudo systemctl restart wallarm-tarantool`
    ```

##  10. Настройка логирования

--8<-- "../include/installation-step-logging.md"


##  11. Перезапуск NGINX

Перезапустите NGINX, используя следующую команду:

``` bash
sudo systemctl restart nginx
```

## Установка завершена

На этом установка завершена.

--8<-- "../include/check-setup-installation-ru.md"

--8<-- "../include/filter-node-defaults.md"

--8<-- "../include/installation-extra-steps.md"