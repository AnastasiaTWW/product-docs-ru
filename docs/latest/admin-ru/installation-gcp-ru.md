[link-launch-instance]:     https://cloud.google.com/deep-learning-vm/docs/quickstart-marketplace

[img-ssh-key-generation]:       ../images/installation-gcp/common/ssh-key-generation.png

# Развертывание на Google Cloud Platform

Развертывание WAF‑ноды на Google Cloud Platform (GCP) включает в себя следующие шаги:

1.  Вход в учетную запись Google Cloud Platform.
2.  Запуск инстанса с WAF‑нодой Валарм.
3.  Настройка инстанса с WAF‑нодой Валарм.
4.  Подключение по SSH к инстансу с WAF‑нодой.
5.  Подключение WAF‑ноды к облаку Валарм.
6.  Настройка WAF‑ноды для использования прокси‑сервера.
7.  Настройка правил проксирования и фильтрации.
8.  Настройка выделения оперативной памяти для WAF‑ноды.
9.  Настройка логирования.
10. Перезапуск NGINX.

    

    
    
## 1. Вход в учетную запись Google Cloud Platform

Войдите в [console.cloud.google.com](https://console.cloud.google.com/).

## 2. Запуск инстанса с WAF‑нодой Валарм

!!! info "Если Валарм WAF уже установлен"
    Если вы запускаете инстанс вместо существующего Валарм WAF или дублируете инстанс, используйте версию существующего Валарм WAF или обновите версии всех инстансов до последней.

    Чтобы получить текущую версию, используйте команду: 

    ```
    apt list wallarm-node
    ```

    * Если установлена версия `2.18.x`, используйте текущую инструкцию.
    * Если установлена версия `2.16.x`, используйте [инструкцию для 2.16](../../2.16/admin-ru/installation-gcp-ru/) или обновите все инстансы Валарм WAF до 2.18.
    * Если установлена версия `2.14.x` или ниже, обновите все инстансы Валарм WAF до 2.18.

    Более подробная информация о поддержке версий доступна в [политике версионирования WAF‑ноды](../updating-migrating/versioning-policy.md).

### Запуск через интерфейс Google Cloud Platform

Чтобы запустить инстанс с WAF‑нодой через интерфейс Google Cloud Platform, откройте [образ WAF‑ноды](https://console.cloud.google.com/launcher/details/wallarm-node-195710/wallarm-node) и нажмите **LAUNCH**.

Инстанс запустится с предустановленной WAF‑нодой. Более подробная информация о запуске инстансов на Google Cloud Platform приведена в [официальной документации Google Cloud Platform][link-launch-instance].

### Запуск через Terraform или другой инструмент

При запуске инстанса с WAF‑нодой с помощью Terraform или другого инструмента вам может потребоваться указать название образа.

* Название образа имеет формат:

    ```bash
    wallarm-node-195710/wallarm-node-<IMAGE_VERSION>-build
    ```
* Чтобы запустить инстанс с WAF‑нодой версии 2.16, используйте название образа:

    ```bash
    wallarm-node-195710/wallarm-node-2-16-0-7-19878-build
    ```

Чтобы получить название образа, вы также можете использовать следующий алгоритм:

1. Установить [Google Cloud SDK](https://cloud.google.com/sdk/docs/install).
2. Выполнить команду [`gcloud compute images list`](https://cloud.google.com/sdk/gcloud/reference/compute/images/list) со следующими параметрами:
    
    ```bash
    gcloud compute images list --project wallarm-node-195710 --filter="name~'wallarm-node-2-16-*'" --no-standard-images
    ```

3. Скопировать версию из названия последнего доступного образа и вставить скопированное значение в приведенный формат названия образа. Например, для образа WAF‑ноды версии 2.16:

    ```bash
    wallarm-node-195710/wallarm-node-2-16-0-7-19878-build
    ```

## 3. Настройка инстанса с WAF‑нодой Валарм

Для того, чтобы настроить запущенный инстанс с WAF‑нодой Валарм, выполните следующие действия:
1.  Перейдите на страницу *VM instances* в разделе *Compute Engine* навигационного меню.

2.  Нажмите на запущенный вами инстанс с WAF‑нодой и нажмите на кнопку *Edit*.

3.  Разрешите необходимые типы входящего трафика к WAF‑ноде, установив требуемые галочки в пункте *Firewalls*.

4.  При необходимости вы можете запретить подключение к инстансу с использованием SSH-ключей проекта и задействовать собственную пару SSH-ключей для подключения к этому инстансу. Для этого выполните следующие действия:

    1.  Поставьте галочку «Block project-wide» в пункте *SSH Keys*.
    
    2.  Нажмите на кнопку *Show and edit* в пункте *SSH Keys*, чтобы развернуть поле для ввода SSH-ключа.
    
    3.  Сгенерируйте пару из открытого и закрытого SSH-ключей. Например, вы можете использовать утилиты `ssh-keygen` или `PuTTYgen`;
       
        ![!Генерация SSH-ключей с помощью PuTTYgen][img-ssh-key-generation]

    4.  Скопируйте открытый ключ в формате OpenSSH из интерфейса используемой утилиты для генерации SSH-ключей (в этом примере с генерацией ключей в PuTTYgen необходимо скопировать открытый ключ из поля *Public key for pasting into OpenSSH authorized_keys file*) и вставьте его в поле, содержащее подсказку «Enter entire key data».
    
    5.  Сохраните закрытый ключ. В будущем он будет необходим для подключения к настроенному инстансу.
    
5.  Нажмите на кнопку *Save* внизу страницы, чтобы сохранить внесенные изменения.



## 4. Подключение по SSH к инстансу с WAF‑нодой

Информация о способах подключения к инстансам доступна по ссылке [Google Cloud Platform: Connecting to Instances](https://cloud.google.com/compute/docs/instances/connecting-to-instance).

!!! info "Подключение к инстансу с использованием собственного закрытого ключа"
    Если в процессе создания инстанса вы настроили собственную пару SSH-ключей для использования вместо пары ключей проекта при подключении к инстансу по протоколу SSH, то убедитесь, что вы имеете доступ к закрытому ключу из этой пары.

## 5. Подключение WAF‑ноды к облаку Валарм

--8<-- "../include/connect-cloud-node-cloud-ru-2.16.md"

## 6. Настройка WAF‑ноды для использования прокси‑сервера

--8<-- "../include/setup-proxy.md"

## 7. Настройка правил проксирования и фильтрации

--8<-- "../include/setup-filter-nginx-ru.md"

## 8. Настройка выделения оперативной памяти для WAF‑ноды

WAF‑нода использует находящееся в памяти хранилище Tarantool.

По умолчанию развернутый образ WAF‑ноды Валарм выделяет под Tarantool 40% от общей памяти инстанса.

Вы можете изменить объем оперативной памяти для Tarantool:

1.  Откройте для редактирования конфигурационный файл Tarantool:

    ``` bash
    sudo vim /etc/default/wallarm-tarantool
    ```

2.  Укажите размер выделенной памяти в директиве `SLAB_ALLOC_ARENA` в ГБ. Значение может быть целым или дробным (разделитель целой и дробной части — точка). Например, 24 ГБ:

    ```bash
    SLAB_ALLOC_ARENA=24
    ```

3.  Чтобы применить сделанные изменения, перезапустите Tarantool:

    ``` bash
    sudo systemctl restart wallarm-tarantool
    ```

##  9.  Настройка логирования

--8<-- "../include/installation-step-logging.md"

## 10.  Перезапуск NGINX

Перезапустите NGINX, используя следующую команду:

``` bash
sudo systemctl restart nginx
```

## Установка завершена

На этом установка завершена.

--8<-- "../include/check-setup-installation-ru.md"

--8<-- "../include/filter-node-defaults.md"

--8<-- "../include/installation-extra-steps.md"
