[link-doc-asg-guide]:               autoscaling-group-guide.md  
[link-docs-check-operation]:        ../../installation-check-operation-ru.md

[link-aws-lb-comparison]:           https://docs.aws.amazon.com/elasticloadbalancing/latest/userguide/what-is-load-balancing.html?icmpid=docs_elbv2_console#elb-features   

[img-lb-basics]:                    ../../../images/installation-ami/auto-scaling/common/load-balancing-guide/lb-create-1.png
[img-lb-routing]:                   ../../../images/installation-ami/auto-scaling/common/load-balancing-guide/lb-create-3.png
[img-checking-operation]:           ../../../images/test-attack.png

[anchor-create]:        #1-создание-балансировщика-нагрузки
[anchor-configure]:     #2-настройка-группы-автоматического-масштабирования-для-использования-созданного-балансировщика

#   Настройка балансировки входящих соединений для группы автомасштабирования

Теперь, когда у вас есть [настроенная][link-doc-asg-guide] группа автоматического масштабирования WAF‑нод, необходимо создать и настроить балансировщик нагрузки (Load Balancer), который будет распределять входящие HTTP‑ и HTTPS‑соединения по нескольким WAF‑нодам в группе масштабирования.

Работа с балансировщиком нагрузки включает в себя следующие шаги:
1.  [Создание балансировщика нагрузки.][anchor-create]
2.  [Настройка группы автоматического масштабирования для использования созданного балансировщика.][anchor-configure]

##  1.  Создание балансировщика нагрузки

Вы можете настроить несколько типов балансировщиков нагрузки в облаке Amazon:
*   Classic Load Balancer,
*   Network Load Balancer,
*   Application Load Balancer.

!!! info "Сравнение балансировщиков нагрузки"
    Подробная информация о различиях балансировщиков доступна [здесь][link-aws-lb-comparison].

В этом документе в качестве примера будут продемонстрированы настройка и использование Network Load Balancer, который занимается балансировкой на транспортном уровне сетевой модели OSI/ISO.

Создайте балансировщик нагрузки, выполнив следующие действия:
1.  Перейдите на вкладку *Load Balancers* в дашборде Amazon EC2 и нажмите на кнопку *Create Load Balancer*.

2.  Создайте Network Load Balancer, нажав на соответствующую кнопку *Create*.

3.  Настройте базовые параметры балансировщика:

    ![!Настройка базовых параметров балансировщика][img-lb-basics]
    
    1.  Имя балансировщика (параметр *Name*).
    
    2.  Тип балансировщика (параметр *Scheme*). 
        
        Обычно необходимо, чтобы балансировщик был доступен в Интернете. Для этого выберите вариант «internet-facing».
    
    3.  Укажите, на каких портах необходимо слушать входящие соединения, с помощью группы параметров *Listeners*.
    
    4.  Задайте необходимые VPC и зоны доступности (Availability Zones), в которых балансировщик должен осуществлять маршрутизацию трафика;
        
        !!! info "Проверьте доступность группы масштабирования"
            Убедитесь, что вы выбрали VPC и зоны доступности, в которых находится [развернутая ранее][link-doc-asg-guide] группа автоматического масштабирования.
        
4.  Перейдите к следующему шагу, нажав на кнопку *Next: Configure Security Settings*. 
    
    При необходимости настройте параметры безопасности.
    
5.  Перейдите к следующему шагу, нажав на кнопку *Next: Configure Routing*.

    Настройте маршрутизацию входящих соединений к WAF‑нодам в группе автоматического масштабирования:

    ![!Настройка маршрутизации входящих соединений][img-lb-routing]
    
    1.  Создайте новую целевую группу и задайте для нее имя в поле *Name*.         
        Балансировщик нагрузки будет маршрутизировать входящие запросы к инстансам, находящимся в указанной целевой группе (например, «demo-target»).
        
    2.  Настройте протокол и порт, с помощью которого необходимо осуществлять маршрутизацию запросов. 
    
        Для WAF‑ноды укажите протокол TCP, порты 80 и 443 (если у вас присутствует HTTPS‑трафик).
        
    3.  При необходимости настройте проверку доступности с помощью группы параметров *Health Checks*.
    
6.  Перейдите к следующему шагу, нажав на кнопку *Next: Register Targets*. 

    На данном шаге не требуется выполнять никаких действий.
    
7.  Перейдите к следующему шагу, нажав на кнопку *Next: Review*.

    Убедитесь, что все параметры заданы верно, и запустите процесс создания балансировщика нагрузки, нажав на кнопку *Create*.

!!! info "Дождитесь окончания настройки балансировщика"
    После создания балансировщика должно пройти некоторое количество времени, прежде чем он сможет принимать трафик.

##  2.  Настройка группы автоматического масштабирования для использования созданного балансировщика

Настройте вашу группу масштабирования так, чтобы балансировщик нагрузки отправлял трафик на запущенные в ней инстансы WAF‑ноды.

Для этого выполните следующие действия:
1.  Перейдите на вкладку «Auto Scaling Groups» в дашборде Amazon EC2 и выберите [ранее созданную][link-doc-asg-guide] группу масштабирования.

2.  Откройте диалог изменения настроек группы, выбрав в выпадающем меню *Actions* пункт «Edit».

3.  В выпадающем списке *Target groups* выберите [созданную][anchor-create] при создании балансировщика нагрузки целевую группу «demo-target».

4.  Сохраните внесенные изменения, нажав на кнопку *Save*.

Теперь вы сможете обрабатывать ваш входящий трафик к приложению с помощью динамически изменяемого набора WAF‑нод Валарм.

Вы можете проверить работоспособность развернутых WAF‑нод следующим образом:
1.  Убедитесь, что ваше приложение доступно через балансировщик нагрузки и WAF‑ноды Валарм, перейдя по IP‑адресу балансировщика или обратившись к его доменному имени в браузере;

2.  Убедитесь, что сервисы Валарм защищают ваше приложение, [выполнив][link-docs-check-operation] тестовую атаку:

    ![!Проверка работоспособности WAF‑нод][img-checking-operation]