# Запуск Docker‑образа на основе Envoy

## Обзор образа

Инструкция описывает шаги для запуска Docker‑образа WAF на основе [Envoy 1.15.0](https://www.envoyproxy.io/docs/envoy/v1.15.0/). Образ содержит все системы, необходимые для корректной работы WAF:

* Сервисы прокси-сервера Envoy с встроенным модулем WAF
* Модули Tarantool для постаналитики
* Другие сервисы и скрипты

Модуль Валарм WAF реализован в виде HTTP‑фильтра Envoy для проксирования запросов.

!!! warning "Поддерживаемые параметры конфигурации"
    Большинство [директив](../../configure-parameters-ru.md) для настройки WAF‑ноды на основе NGINX не поддерживаются при настройке WAF‑ноды на основе Envoy. [Список параметров для настройки WAF‑ноды на основе Envoy →](../../configuration-guides/envoy/fine-tuning.md)

!!! info "Если Валарм WAF уже развернут"
    Если вы разворачиваете образ Валарм WAF вместо существующего образа или дублируете установку, используйте версию существующего Валарм WAF или обновите версии всех образов до последней.

    Чтобы получить текущую версию, выполните команду в контейнере: 

    ```
    yum list wallarm-node
    ```

    * Если установлена версия `2.18.x`, используйте текущую инструкцию.
    * Если установлена версия `2.16.x`, используйте [инструкцию для 2.16](../../../../../2.16/admin-ru/installation-guides/envoy/envoy-docker/) или [обновите все образы до последней версии](../../../../../updating-migrating/docker-container/).
    
    Более подробная информация о поддержке версий доступна в [политике версионирования WAF‑ноды](../../../updating-migrating/versioning-policy.md).

## Требования

* Доступ к аккаунту с ролью **Деплой** или **Администратор** и отключенная двухфакторная аутентификация в Консоли управления Валарм для [RU‑облака](https://my.wallarm.ru) или [EU‑облака](https://my.wallarm.com)
* Доступ виртуальной машины к Валарм API по адресу `api.wallarm.com:444` для EU‑облака или `api.wallarm.ru:444` для RU‑облака. Убедитесь, что доступ не ограничен файерволом

## Варианты запуска контейнера

Параметры WAF‑ноды могут быть переданы в Docker‑контейнер следующими способами:

* **Через переменные окружения**. В контейнер передаются базовые настройки WAF‑ноды, большинство [доступных параметров](../../configuration-guides/envoy/fine-tuning.md) не могут быть переданы через переменные окружения.
* **В примонтированном конфигурационном файле**. В контейнер могут быть переданы все [доступные параметры](../../configuration-guides/envoy/fine-tuning.md) WAF‑ноды.

## Запуск контейнера с переменными окружения

Вы можете передать в контейнер следующие базовые настройки WAF через опцию `-e`:

Переменная окружения | Описание | Обязательная?
---- | ---- | -----
`DEPLOY_USER` | Email для аккаунта пользователя **Деплой** или **Администратор** в Консоли управления Валарм. | Да
`DEPLOY_PASSWORD` | Пароль для аккаунта пользователя **Деплой** или **Администратор** в Консоли управления Валарм. | Да
`ENVOY_BACKEND` | Домен или IP‑адрес ресурса, который необходимо защитить с помощью WAF. | Да
`WALLARM_API_HOST` | Адрес Валарм API:<ul><li>`api.wallarm.com` для EU‑облака</li><li>`api.wallarm.ru` для RU‑облака</li></ul>По умолчанию: `api.wallarm.com`. | Нет
`WALLARM_MODE` | Режим работы WAF‑ноды:<ul><li>`block`, чтобы блокировать вредоносные запросы</li><li>`monitoring`, чтобы анализировать, но не блокировать запросы</li><li>`off`, чтобы не обрабатывать входящий трафик</li></ul>По умолчанию: `monitoring`. | Нет
`TARANTOOL_MEMORY_GB` | Размер [оперативной памяти](../../configuration-guides/allocate-resources-for-waf-node.md) для Tarantool в гигабайтах. Значение может быть целым или дробным (разделитель целой и дробной части — точка). По умолчанию: 0.2 гигабайта. | Нет
`WALLARM_ACL_ENABLE` | Включает [блокировку IP‑адресов](../../configuration-guides/envoy/fine-tuning.md#настройка-блокировки-запросов-по-ipадресам) с настройками по умолчанию. Для включения блокировки, в переменной может быть передано любое значение. По умолчанию блокировка отключена (если переменная не указана явно).<br><br>Чтобы включить блокировку IP‑адресов с другими настройками, необходимо определить соответствующие [параметры](../../configuration-guides/envoy/fine-tuning.md#настройка-блокировки-запросов-по-ipадресам) и запустить контейнер с [примонтированным](#запуск-контейнера-с-примонтированным-конфигурационным-файлом) конфигурационным файлом. | Нет 
`DEPLOY_FORCE` | Заменяет существующую WAF‑ноду на новую, если название WAF‑ноды соответствует идентификатору контейнера, который вы запускаете. Принимает значения:<ul><li>`true`, чтобы заменить WAF‑ноду</li><li>`false`, чтобы отключить замену WAF‑ноды</li></ul>По умолчанию (если переменная не указана явно): `false`.<br>WAF‑ноде Валарм присваивается название, соответствующее идентификатору контейнера. Данная опция полезна, если идентификаторы Docker‑контейнеров в вашей среде статичные и вы повторно запускаете Docker‑контейнер с WAF‑нодой Валарм (например, с новой версией образа). Если в этом случае значение переменной равно `false`, процесс создания WAF‑ноды завершится с ошибкой. | Нет

Для запуска образа используйте команду:

=== "EU‑облако"
    ```bash
    docker run -d -e DEPLOY_USER='deploy@example.com' -e DEPLOY_PASSWORD='very_secret' -e ENVOY_BACKEND='example.com' -e TARANTOOL_MEMORY_GB=16 -p 80:80 wallarm/envoy:2.18.1-3
    ```
=== "RU‑облако"
    ```bash
    docker run -d -e DEPLOY_USER='deploy@example.com' -e DEPLOY_PASSWORD='very_secret' -e ENVOY_BACKEND='example.com' -e WALLARM_API_HOST='api.wallarm.ru' -e TARANTOOL_MEMORY_GB=16 -p 80:80 wallarm/envoy:2.18.1-3
    ```

Команда выполнит следующие действия:

* Автоматически создаст WAF‑ноду в Облаке Валарм. Созданный элемент отобразится в Консоли управления → **Ноды**.
* Создаст файл `envoy.yaml` с минимальными настройками Envoy в директории контейнера `/etc/envoy`.
* Создаст файлы с параметрами для доступа к Облаку Валарм в директории контейнера `/etc/wallarm`:
    * `node.yaml` с UUID WAF‑ноды и секретным ключом
    * `license.key` с лицензионным ключом Валарм
* Защитит ресурс `http://ENVOY_BACKEND:80`

## Запуск контейнера с примонтированным конфигурационным файлом

Вы можете примонтировать в контейнер готовый файл `envoy.yaml` через опцию `-v`. Файл должен содержать следующие настройки:

* Тонкую настройку WAF‑ноды по [инструкции](../../configuration-guides/envoy/fine-tuning.md)
* Настройку Envoy по [инструкции Envoy](https://www.envoyproxy.io/docs/envoy/v1.15.0/configuration/overview/overview)

Для запуска образа:

1. Передайте в контейнер обязательные переменные окружения через опцию `-e`:

    Переменная окружения | Описание | Обязательная?
    ---- | ---- | -----
    `DEPLOY_USER` | Email для аккаунта пользователя **Деплой** или **Администратор** в Консоли управления Валарм. | Да
    `DEPLOY_PASSWORD` | Пароль для аккаунта пользователя **Деплой** или **Администратор** в Консоли управления Валарм. | Да
    `WALLARM_API_HOST` | Адрес Валарм API:<ul><li>`api.wallarm.com` для EU‑облака</li><li>`api.wallarm.ru` для RU‑облака</li></ul>По умолчанию: `api.wallarm.com`. | Нет
    `DEPLOY_FORCE` | Заменяет существующую WAF‑ноду на новую, если название WAF‑ноды соответствует идентификатору контейнера, который вы запускаете. Принимает значения:<ul><li>`true`, чтобы заменить WAF‑ноду</li><li>`false`, чтобы отключить замену WAF‑ноды</li></ul>По умолчанию (если переменная не указана явно): `false`.<br>WAF‑ноде Валарм присваивается название, соответствующее идентификатору контейнера. Данная опция полезна, если идентификаторы Docker‑контейнеров в вашей среде статичные и вы повторно запускаете Docker‑контейнер с WAF‑нодой Валарм (например, с новой версией образа). Если в этом случае значение переменной равно `false`, процесс создания WAF‑ноды завершится с ошибкой. | Нет

2. Примонтируйте директорию с файлом `envoy.yaml` в директорию контейнера `/etc/envoy` через опцию `-v`.

    === "EU‑облако"
        ```bash
        docker run -d -e DEPLOY_USER='deploy@example.com' -e DEPLOY_PASSWORD='very_secret' -e ENVOY_BACKEND='example.com' -e TARANTOOL_MEMORY_GB=16 -v /configs/envoy.yaml:/etc/envoy/envoy.yaml -p 80:80 wallarm/envoy:2.18.1-3
        ```
    === "RU‑облако"
        ```bash
        docker run -d -e DEPLOY_USER='deploy@example.com' -e DEPLOY_PASSWORD='very_secret' -e ENVOY_BACKEND='example.com' -e WALLARM_API_HOST='api.wallarm.ru' -e TARANTOOL_MEMORY_GB=16 -v /configs/envoy.yaml:/etc/envoy/envoy.yaml -p 80:80 wallarm/envoy:2.18.1-3
        ```

Команда выполнит следующие действия:

* Автоматически создаст WAF‑ноду в Облаке Валарм. Созданный элемент отобразится в Консоли управления → **Ноды**.
* Примонтирует файл `envoy.yaml` в директорию контейнера `/etc/envoy`.
* Создаст файлы с параметрами для доступа к Облаку Валарм в директории контейнера `/etc/wallarm`:
    * `node.yaml` с UUID WAF‑ноды и секретным ключом
    * `license.key` с лицензионным ключом Валарм
* Защитит ресурс `http://ENVOY_BACKEND:80`

## Настройка ротации логов (опционально)

Ротация лог‑файлов настроена и включена по умолчанию. При необходимости вы можете изменить настройки ротации в директории `/etc/logrotate.d` контейнера с WAF‑нодой.

## Тестирование работы Валарм WAF

1. Отправьте тестовый запрос с атаками [SQLI](../../../attacks-vulns-list.md#sqlинъекция-sql-injection) и [XSS](../../../attacks-vulns-list.md#межсайтовый-скриптинг-англ-cross-site-scripting-xss) на адрес защищенного ресурса:

    ```
    curl http://localhost/?id='or+1=1--a-<script>prompt(1)</script>'
    ```

    Если WAF‑нода работает в режиме `block`, запрос будет заблокирован с ответом `403 blocked by wallarm filter`.
2. Перейдите в Консоль управления Валарм → секция **События** для [EU‑облака](https://my.wallarm.com/search) или для [RU‑облака](https://my.wallarm.ru/search) и убедитесь, что атаки появились в списке.
    ![!Атаки в интерфейсе](../../../images/admin-guides/yandex-cloud/test-attacks.png)
