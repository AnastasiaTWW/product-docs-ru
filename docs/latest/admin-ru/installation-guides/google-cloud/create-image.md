[link-docs-gcp-autoscaling]:        autoscaling-overview.md
[link-docs-gcp-node-setup]:         ../../installation-gcp-ru.md
[link-cloud-connect-guide]:         ../../installation-gcp-ru.md#5-подключение-wafноды-к-облаку-валарм
[link-docs-reverse-proxy-setup]:    ../../../quickstart-ru/qs-setup-proxy-ru.md
[link-docs-check-operation]:        ../../installation-check-operation-ru.md


[img-vm-instance-poweroff]:     ../../../images/installation-gcp/auto-scaling/common/create-image/vm-poweroff.png
[img-create-image]:             ../../../images/installation-gcp/auto-scaling/common/create-image/create-image.png
[img-check-image]:              ../../../images/installation-gcp/auto-scaling/common/create-image/image-list.png

[anchor-node]:  #1-создание-и-настройка-экземпляра-wafноды
[anchor-gcp]:   #2-создание-образа-виртуальной-машины

#   Создание образа с WAF‑нодой Валарм на Google Cloud Platform

Этот документ описывает, как подготовить образ виртуальной машины с WAF‑нодой на Google Cloud Platform. Такой образ будет необходим вам при настройке автоматического масштабирования WAF‑нод. Подробнее о настройке масштабирования вы можете прочитать [здесь][link-docs-gcp-autoscaling].

Чтобы создать образ с WAF‑нодой Валарм на GCP, необходимо выполнить следующие шаги:
1.  [Создание и настройка экземпляра WAF‑ноды на Google Cloud Platform][anchor-node];
2.  [Создание образа виртуальной машины на основе настроенного экземпляра WAF‑ноды][anchor-gcp].

##  1.  Создание и настройка экземпляра WAF‑ноды

Перед созданием образа виртуальной машины вам необходимо выполнить начальную настройку единичной WAF‑ноды Валарм. Для этого:
1.  [Создайте и настройте][link-docs-gcp-node-setup] экземпляр WAF‑ноды (инстанс) на GCP.

    !!! warning "Обеспечьте доступ к Валарм API"
        Для корректной работы WAF‑ноды ей требуется доступ к API-серверам Валарм. Адрес зависит от облака, которое вы используете:
        
        * `https://api.wallarm.com:444` для EU‑облака
        * `https://api.wallarm.ru:444` для RU‑облака
    
    !!! info "Подключение к инстансу с использованием собственного закрытого ключа"
        Если в процессе создания инстанса вы настроили собственную пару SSH-ключей для использования вместо пары ключей проекта при подключении к инстансу по протоколу SSH, то убедитесь, что вы имеете доступ к закрытому ключу из этой пары.

2.  [Подключите][link-cloud-connect-guide] WAF‑ноду к облаку Валарм.

    !!! warning "Используйте токен для подключения к облаку Валарм"
        Обратите внимание, что необходимо использовать вариант подключения с использованием токена. Это позволит нескольким WAF‑нодам подключаться к облаку Валарм с помощью одного и того же токена.
       
        Таким образом, при масштабировании WAF‑нод не потребуется подключать к облаку Валарм каждую отдельную WAF‑ноду вручную. 

3.  [Настройте][link-docs-reverse-proxy-setup] WAF‑ноду так, чтобы она выступал в качестве обратного прокси (reverse proxy) для вашего веб‑приложения.

4.  [Убедитесь][link-docs-check-operation], что WAF‑нода настроена правильно и защищает ваше веб‑приложение от атак.

Когда вы завершите настройку, выключите виртуальную машину с WAF‑нодой, выполнив следующие действия:
1.  Перейдите на страницу *VM Instances* в разделе *Compute Engine* навигационного меню.
2.  Откройте меню действий для инстанса с настроенной WAF‑нодой, нажав на кнопку меню, расположенную справа от колонки *Connect*.
3.  В меню действий выберите действие *Stop*.

![!Выключение виртуальной машины][img-vm-instance-poweroff]

!!! info "Выключение с помощью команды `poweroff`"
    Вы также можете выключить виртуальную машину, подключившись к ней с использованием протокола SSH и выполнив следующую команду: 
 	
 	``` bash
 	poweroff
 	```


##  2.  Создание образа виртуальной машины

Теперь вы можете приступить к созданию образа виртуальной машины на основе настроенного экземпляра WAF‑ноды. Выполните следующие действия:
1.  Перейдите на страницу *Images* в разделе *Compute Engine* навигационного меню и нажмите на кнопку *Create image*.
2.  Введите имя создаваемого образа в поле *Name*.
3.  В выпадающем списке *Source* выберите пункт «Disk».
4.  В выпадающем списке *Source disk* выберите имя созданного вами [ранее][anchor-node] инстанса виртуальной машины.

    ![!Создание образа][img-create-image]

5.  Нажмите на кнопку *Create* для запуска процесса создания образа виртуальной машины.

Когда процесс создания образа завершится, вы будете перенаправлены на страницу со списком доступных вам образов. Убедитесь, что в списке присутствует созданный вами образ WAF‑ноды.

![!Список образов виртуальных машин][img-check-image]

Теперь вы можете выполнить [настройку автоматического масштабирования][link-docs-gcp-autoscaling] WAF‑нод Валарм на Google Cloud Platform, используя подготовленный образ.