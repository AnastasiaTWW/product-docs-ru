[img-creating-instance-group]:          ../../../images/installation-gcp/auto-scaling/common/autoscaling-group-guide/create-instance-group.png
[img-create-instance-group-example]:    ../../../images/installation-gcp/auto-scaling/common/autoscaling-group-guide/create-scalable-instance-group.png
[img-checking-nodes-operation]:         ../../../images/cloud-node-status.png

[link-cpu-usage-policy]:                            https://cloud.google.com/compute/docs/autoscaler/scaling-cpu-load-balancing
[link-http-load-balancing-policy]:                  https://cloud.google.com/compute/docs/autoscaler/scaling-cpu-load-balancing#scaling_based_on_https_load_balancing_serving_capacity
[link-stackdriver-monitoring-metric-policy]:        https://cloud.google.com/compute/docs/autoscaler/scaling-stackdriver-monitoring-metrics
[link-multiple-metrics-policy]:                     https://cloud.google.com/compute/docs/autoscaler/multiple-policies
[link-creating-load-balancer]:                      load-balancing-guide.md

#  Создание управляемой группы экземпляров виртуальных машин с автоматическим масштабированием

Чтобы создать управляемую группу экземпляров виртуальных машин и настроить для нее автоматическое масштабирование, выполните следующие действия:

1.  Перейдите на страницу «Instance groups» в разделе «Compute Engine» навигационного меню и нажмите на кнопку «Create instance group»;

    ![!Создание группы экземпляров][img-creating-instance-group]

2.  Введите имя создаваемой группы экземпляров в поле «Name»;

3.  Выберите «Managed instance group» в пункте «Group type»;

4.  Включите автоматическое масштабирование для создаваемой группы экземпляров, выбрав «On» в выпадающем списке «Autoscaling»;

5.  Задайте необходимую политику масштабирования, выбрав соответствующий пункт в выпадающем списке «Autoscaling policy». 
    
    Политики содержат правила увеличения и уменьшения размера группы экземпляров. Система сама определяет, когда необходимо добавить или удалить инстанс, чтобы приблизить значение показателя, на котором основывается политика, к целевому значению, указанному пользователем.
    
    Вы можете выбрать одну из следующих политик:
    
    1.  CPU usage — размер группы регулируется для поддержания средней загруженности процессоров виртуальных машин в группе на требуемом уровне ([документация по использованию политики][link-cpu-usage-policy]);
    2.  HTTP load balancing usage — размер группы регулируется для поддержания нагрузки на балансировщик HTTP‑трафика на требуемом уровне ([документация по использованию политики][link-http-load-balancing-policy]);
    3.  Stackdriver Monitoring Metric — размер группы регулируется для поддержания выбранной метрики из инструмента Stackdriver Monitoring на желаемом уровне ([документация по использованию политики][link-stackdriver-monitoring-metric-policy]);
    4.  Вы также можете выбрать пункт «Multiple metrics» в поле «Autoscaling policy», чтобы принимать решение об изменении размера группы масштабирования на основе нескольких метрик ([документация по использованию политики][link-multiple-metrics-policy]). 
    
    В этом руководстве для демонстрации принципов работы с механизмом автоматического масштабирования будет использована политика «CPU usage».
    
    Для применения этой политики необходимо указать требуемый средний уровень загруженности процессоров в поле «Target CPU usage» (в процентах).
    
    !!! info "Пример"
        Следующая конфигурация описывает регулировку размера группы для поддержания средней загруженности процессоров виртуальных машин в группе на уровне 60%:
        ![!Пример создаваемой группы экземпляров][img-create-instance-group-example]

6.  Задайте минимальный размер группы инстансов в поле «Minimum number of instances» (например, два инстанса);

7.  Задайте максимальный размер группы инстансов в поле «Maximum number of instances» (например, десять инстансов);

8.  Задайте время «разогрева» добавленного инстанса, в течение которого с него не будут сниматься значения метрик, в поле «Cool down period» (например, 60 секунд). Это может быть необходимо в том случае, если при старте виртуальной машины при добавлении нового инстанса происходят резкие скачки потребления ресурсов; 

    !!! info "Требования ко времени разогрева"
        Время «разогрева» не должно быть меньше, чем время, требуемое для инициализации инстанса.

9.  Убедитесь, что все параметры создаваемой группы инстансов настроены корректно, и нажмите на кнопку «Create».

При успешном создании группы автоматического масштабирования будет автоматически запущено заданное количество инстансов с WAF‑нодой Валарм.

Вы можете проверить, что группа автоматического масштабирования создана правильно, посмотрев количество запущенных в группе инстансов и сравнив эти данные с количеством подключенных к облаку Валарм WAF‑нод.

Это можно сделать на портале Валарм. Например, если в облаке на данный момент запущено два инстанса с WAF‑нодой, то на вкладке *Ноды* портала Валарм количество инстансов отобразится для соответствующей облачной ноды:

![!Вкладка «Ноды» на портале Валарм][img-checking-nodes-operation]

Теперь вы можете переходить к [созданию и настройке балансировщика нагрузки][link-creating-load-balancer].