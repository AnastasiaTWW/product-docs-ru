[doc-nagios-details]:   fetching-metrics.md#выгрузка-метрик-с-помощью-утилиты-collectdnagios

[doc-lom]:              ../../glossary-ru.md#лом

[anchor-tnt]:               #количество-потерянных-запросов-модуль-постаналитики
[anchor-api]:           #количество-потерянных-запросов-валарм-api
[anchor-metric-1]:      #признак-того-что-модуль-постаналитики-отбрасывает-запросы


#   Доступные метрики

* [Формат метрик](#формат-метрик)
* [Типы метрик Валарм](#типы-метрик-валарм)
* [Список метрик NGINX и модуля Валарм для NGINX](#метрики-nginx-и-модуля-валарм-для-nginx)
* [Список метрик модуля постаналитики](#метрики-модуля-постаналитики)

##  Формат метрик

Метрики `collectd` имеют следующий формат:

```
host/plugin[-plugin_instance]/type[-type_instance]
```

Более подробное описание формата доступно по [ссылке](../monitoring/intro.md#как-выглядят-метрики-collectd).

!!! info "Примечание"
    * В списке метрик ниже параметр `host/` опущен.
    * При использовании утилиты `collectd_nagios` параметр `host/` опускается. Имя хоста задается отдельно с помощью параметра `-H` ([подробнее об использовании утилиты][doc-nagios-details]).

## Типы метрик Валарм

Валарм использует типы метрик, перечисленные ниже. Тип указывается в параметре `type` метрики.

* `gauge` — числовое значение измеряемой величины. Значение может увеличиваться и уменьшаться.

* `derive` — скорость изменения значения измеряемой величины с момента предыдущего измерения значения (производная величина). Значение может увеличиваться и уменьшаться.

* `counter` — числовое значение измеряемой величины. Значение может только увеличиваться.

##  Метрики NGINX и модуля Валарм для NGINX

### Количество запросов

Количество запросов, обработанных с момента установки WAF‑ноды.

* **Величина:** `curl_json-wallarm_nginx/gauge-requests`
* **Значение величины:** 
    * `0` для [режима](../configure-wallarm-mode.md#возможные-режимы-фильтрации) `off`
    * `>0` для [режима](../configure-wallarm-mode.md#возможные-режимы-фильтрации) `monitoring`/`block`
* **Скорость изменения:** `curl_json-wallarm_nginx/derive-requests`
* **Рекомендации при отклонении значений:**
      1. Проверьте корректность настроек WAF‑ноды.
      2. Проверьте работоспособность WAF‑ноды, как описано в [инструкции](../installation-check-operation-ru.md). После одной тестовой атаки значение должно увеличиться на `1`.

### Количество атак

Количество атак, зафиксированных WAF‑нодой с момента установки.

* **Величина:** `curl_json-wallarm_nginx/gauge-attacks`
* **Значение величины:** 
    * `0` для [режима](../configure-wallarm-mode.md#возможные-режимы-фильтрации) `off`
    * `>0` для [режима](../configure-wallarm-mode.md#возможные-режимы-фильтрации) `monitoring`/`block`
* **Скорость изменения:** `curl_json-wallarm_nginx/derive-attacks`
* **Рекомендации при отклонении значений:**
    1. Проверьте корректность настроек WAF‑ноды.
    2. Проверьте работоспособность WAF‑ноды, как описано в [инструкции](../installation-check-operation-ru.md). После одной тестовой атаки значение должно увеличиться на `1`.

### Количество заблокированных запросов

Количество запросов, заблокированных WAF‑нодой с момента установки. Метрика записывается, если нода находится в [режиме](../configure-wallarm-mode.md#возможные-режимы-фильтрации) `block`.

* **Величина:** `curl_json-wallarm_nginx/gauge-blocked`
* **Значение величины:** 
    * `0` для [режима](../configure-wallarm-mode.md#возможные-режимы-фильтрации) `off`/`monitoring`
    * `>0` для [режима](../configure-wallarm-mode.md#возможные-режимы-фильтрации) `block`
* **Скорость изменения:** `curl_json-wallarm_nginx/derive-blocked`
* **Рекомендации при отклонении значений:** 
    1. Проверьте настройки WAF‑ноды и статус `block`.
    2. Проверьте работоспособность WAF‑ноды, как описано в [инструкции](../installation-check-operation-ru.md). После одной тестовой атаки значение должно увеличиться на `1`.

### Количество нетипичных запросов

Количество запросов, нетипичных для приложения. Временно в метрику записываются все запросы, обработанные WAF‑нодой ([`gauge-requests`](#количество-запросов)).

* **Величина:** `curl_json-wallarm_nginx/gauge-abnormal`
* **Значение величины:** временно равно [`gauge-requests`](#количество-запросов)
* **Скорость изменения:** `curl_json-wallarm_nginx/derive-abnormal`
* **Рекомендации при отклонении значений:** временно не имеют значения

### Количество потерянных запросов

Количество запросов, которые не были проанализированы модулем постаналитики или не были переданы в Валарм API. К запросам применяются правила блокировки, но запросы не отображаются в интерфейсе Личного кабинета и не учитываются при проверке следующих запросов. Значение параметра формируется из суммы [`tnt_errors`][anchor-tnt] и [`api_errors`][anchor-api].

* **Величина:** `curl_json-wallarm_nginx/gauge-requests_lost`
* **Значение величины:** `0`, формируется из суммы [`tnt_errors`][anchor-tnt] и [`api_errors`][anchor-api]
* **Скорость изменения:** `curl_json-wallarm_nginx/derive-requests_lost`
* **Рекомендации при отклонении значений:** проверьте значения [`tnt_errors`][anchor-tnt] и [`api_errors`][anchor-api], следуйте описанным рекомендациям ниже

#### Количество потерянных запросов: модуль постаналитики

Количество запросов, которые не были проанализированы модулем постаналитики. Метрика записывается, если все запросы отправляются в модуль постаналитики ([`wallarm_upstream_backend tarantool`](../configure-parameters-ru.md#wallarm_upstream_backend)). К запросам применяются правила блокировки, но запросы не отображаются в интерфейсе Личного кабинета и не учитываются при проверке следующих запросов.

* **Величина:** `curl_json-wallarm_nginx/gauge-tnt_errors`
* **Значение величины:** `0`
* **Скорость изменения:** `curl_json-wallarm_nginx/derive-tnt_errors`
* **Рекомендации при отклонении значений:** 
    * Проверьте логи NGINX и Tarantool, проанализируйте записанные ошибки.
    * Проверьте корректность указанного сервера Tarantool ([`wallarm_tarantool_upstream`](../configure-parameters-ru.md#wallarm_tarantool_upstream)).
    * Убедитесь, что Tarantool хватает выделенной памяти ([`wallarm_ts_request_memory_limit`](../configure-parameters-ru.md#wallarm_ts_request_memory_limit)).
    * Обратитесь в [службу поддержки Валарм](mailto:support@wallarm.com), если не удалось решить проблему.

#### Количество потерянных запросов: Валарм API

Количество запросов, которые не были переданы в Валарм API. Метрика записывается, если все запросы отправляются в API ([`wallarm_upstream_backend api`](../configure-parameters-ru.md#wallarm_upstream_backend)). К запросам применяются правила блокировки, но запросы не отображаются в интерфейсе Личного кабинета и не учитываются при проверке следующих запросов.

* **Величина:** `curl_json-wallarm_nginx/gauge-api_errors`
* **Значение величины:** `0`
* **Скорость изменения:** `curl_json-wallarm_nginx/derive-api_errors`
* **Рекомендации при отклонении значений:** 
    * Проверьте логи NGINX и проанализируйте записанные ошибки.
    * Проверьте корректность настроек API ([`wallarm_api_conf`](../configure-parameters-ru.md#wallarm_api_conf)).
    * Убедитесь, что Tarantool хватает выделенной памяти ([`wallarm_ts_request_memory_limit`](../configure-parameters-ru.md#wallarm_ts_request_memory_limit)).
    * Обратитесь в [службу поддержки Валарм](mailto:support@wallarm.com), если не удалось решить проблему.

### Количество проблем при завершении рабочего процесса NGINX

Количество проблем, которые привели к некорректному завершению рабочего процесса NGINX. Чаще всего причиной является критичная ошибка в работе NGINX.

* **Величина:** `curl_json-wallarm_nginx/gauge-segfaults`
* **Значение величины:** `0`
* **Скорость изменения:** `curl_json-wallarm_nginx/derive-segfaults`
* **Рекомендации при отклонении значений:** 
    1. Соберите информацию о текущем состоянии, используя скрипт `/usr/share/wallarm-common/collect-info.sh`.
    2. Передайте сгенерированный файл в [службу поддержки Валарм](mailto:support@wallarm.com).

### Количество превышений размера виртуальной памяти

Количество ситуаций, когда был превышен размер виртуальной памяти.

* **Величина:** 
    * `curl_json-wallarm_nginx/gauge-memfaults` при превышении памяти в вашей системе
    * `curl_json-wallarm_nginx/gauge-softmemfaults` при превышении памяти для экземпляра proton.db+lom ([`wallarm_ts_request_memory_limit`](../configure-parameters-ru.md#wallarm_ts_request_memory_limit)) 
* **Значение величины:** `0`
* **Скорость изменения:**
    * `curl_json-wallarm_nginx/derive-memfaults` для `curl_json-wallarm_nginx/gauge-memfaults`
    * `curl_json-wallarm_nginx/derive-softmemfaults` для `curl_json-wallarm_nginx/gauge-softmemfaults`
* **Рекомендации при отклонении значений:**
    1. Соберите информацию о текущем состоянии, используя скрипт `/usr/share/wallarm-common/collect-info.sh`.
    2. Передайте сгенерированный файл в [службу поддержки Валарм](mailto:support@wallarm.com).

### Время анализа запросов (в секундах)

Время, потраченное WAF‑нодой на анализ запросов с момента установки.

* **Величина:** `curl_json-wallarm_nginx/gauge-time_detect`
* **Значение величины:** `>0`
* **Скорость изменения:** `curl_json-wallarm_nginx/derive-time_detect`
* **Рекомендации при отклонении значений:**
    1. Проверьте корректность настроек WAF‑ноды.
    2. Проверьте работоспособность WAF‑ноды, как описано в [инструкции](../installation-check-operation-ru.md). После одной тестовой атаки значение должно увеличиться на `1`.

### Версия proton.db

Версия подключенной proton.db.

* **Величина:** `curl_json-wallarm_nginx/gauge-db_id`
* **Значение величины:** ограничений нет

### Версия ЛОМ

Версия подключенного [ЛОМ][doc-lom].

* **Величина:** `curl_json-wallarm_nginx/gauge-lom_id`
* **Значение величины:** ограничений нет

### Экземпляры proton.db и ЛОМ

#### Количество экземпляров proton.db и ЛОМ

Количество подключенных экземпляров proton.db и [ЛОМ][doc-lom].

* **Величина:** `curl_json-wallarm_nginx/gauge-proton_instances-total`
* **Значение величины:** `>0`
* **Рекомендации при отклонении значений:**
    * Проверьте корректность настроек WAF‑ноды.
    * Проверьте корректность пути до файла proton.db ([`wallarm_global_trainingset_path`](../configure-parameters-ru.md#wallarm_global_trainingset_path)).
    * Проверьте корректность пути до файла ЛОМ ([`wallarm_local_trainingset_path`](../configure-parameters-ru.md#wallarm_local_trainingset_path)).

#### Количество успешно загруженных экземпляров proton.db и ЛОМ

Количество экземпляров proton.db и [ЛОМ][doc-lom], которые были успешно прочитаны и загружены.

* **Величина:** `curl_json-wallarm_nginx/gauge-proton_instances-success`
* **Значение величины:** `>0`
* **Рекомендации при отклонении значений:** 
    * Проверьте корректность настроек WAF‑ноды.
    * Проверьте корректность пути до файла proton.db ([`wallarm_global_trainingset_path`](../configure-parameters-ru.md#wallarm_global_trainingset_path)).
    * Проверьте корректность пути до файла ЛОМ ([`wallarm_local_trainingset_path`](../configure-parameters-ru.md#wallarm_local_trainingset_path)).

#### Количество экземпляров proton.db и ЛОМ из последних сохраненных файлов

Количество экземпляров proton.db и [ЛОМ][doc-lom] из последних сохраненных файлов. В сохраненные файлы записываются последние успешно загруженные экземпляры. Если экземпляры обновились, но их не удалось загрузить, используются данные из сохраненных файлов.

* **Величина:** `curl_json-wallarm_nginx/gauge-proton_instances-fallback`
* **Значение величины:** `>0`
* **Рекомендации при отклонении значений:** 
    * Проверьте корректность настроек WAF‑ноды.
    * Проверьте корректность пути до файла proton.db ([`wallarm_global_trainingset_path`](../configure-parameters-ru.md#wallarm_global_trainingset_path)).
    * Проверьте корректность пути до файла ЛОМ ([`wallarm_local_trainingset_path`](../configure-parameters-ru.md#wallarm_local_trainingset_path)).

#### Количество неактивных экземпляров proton.db и ЛОМ

Количество подключенных экземпляров proton.db и [ЛОМ][doc-lom], которые не удалось прочитать.

* **Величина:** `curl_json-wallarm_nginx/gauge-proton_instances-failed`
* **Значение величины:** `0`
* **Рекомендации при отклонении значений:**
    * Проверьте корректность настроек WAF‑ноды.
    * Проверьте корректность пути до файла proton.db ([`wallarm_global_trainingset_path`](../configure-parameters-ru.md#wallarm_global_trainingset_path)).
    * Проверьте корректность пути до файла ЛОМ ([`wallarm_local_trainingset_path`](../configure-parameters-ru.md#wallarm_local_trainingset_path)).

##  Метрики модуля постаналитики

### Идентификатор последнего обработанного запроса

ID последнего обработанного запроса. Значение может как увеличиваться, так и уменьшаться.

* **Величина:** 
    * `wallarm-tarantool/counter-last_request_id`, если значение увеличилось
    * `wallarm-tarantool/gauge-last_request_id`, если значение уменьшилось
* **Значение величины:** нет ограничений
* **Рекомендации при отклонении значений:** если при поступающих запросах значение не изменяется, проверьте корректность настроек WAF‑ноды

### Удаление запросов

#### Признак удаления запросов

Флаг, сигнализирующий об удалении из модуля постаналитики запросов, которые содержат атаки и не отправлены в [облако](../../about-wallarm-waf/overview.md#облако).

* **Величина:** `wallarm-tarantool/gauge-export_drops_flag`
* **Значение величины:** 
    * `0`, если запросы не удаляются
    * `1`, если запросы удаляются (сигнализирует о недостаточном объеме памяти, необходимо следовать рекомендациям ниже)
* **Рекомендации при отклонении значений:**
    * Увеличьте значение [`wallarm_ts_request_memory_limit`](../configure-parameters-ru.md#wallarm_ts_request_memory_limit).
    * Установите модуль постаналитики на отдельный сервер, как описано в [инструкции](../installation-postanalytics-ru.md).

#### Количество удаленных запросов

Количество удаленных запросов, которые содержат атаки и не отправлены в [облако](../../about-wallarm-waf/overview.md#облако). Количество атак в запросе не влияет на значение показателя. Метрика записывается, если [`wallarm-tarantool/gauge-export_drops_flag: 1`](#признак-удаления-запросов).

При настройке уведомлений мониторинга рекомендуется отслеживать значение метрики [`wallarm-tarantool/gauge-export_drops_flag`](#признак-удаления-запросов).

* **Величина:** `wallarm-tarantool/gauge-export_drops`
* **Значение величины:** `0`
* **Скорость изменения:** `wallarm-tarantool/derive-export_drops`
* **Рекомендации при отклонении значений:**
    * Увеличьте значение [`wallarm_ts_request_memory_limit`](../configure-parameters-ru.md#wallarm_ts_request_memory_limit).
    * Установите модуль постаналитики на отдельный сервер, как описано в [инструкции](../installation-postanalytics-ru.md).

### Задержка экспорта запросов (в секундах)

Задержка между записью запроса модулем постаналитики и выгрузкой информации об обнаруженных атаках в облако Валарм.

* **Величина:** `wallarm-tarantool/gauge-export_delay`
* **Значение величины:** 
    * оптимальное `<60`
    * предупреждающее `>60`
    * критичное `>300`
* **Рекомендации при отклонении значений:**
    * Проверьте логи в файле `/var/log/wallarm/export-attacks.log` и проанализируйте записанные ошибки. Увеличение значения может быть вызвано проблемами с пропускной способностью Валарм API: проблемы соединения с API, большое количество атак.
    * Убедитесь, что Tarantool хватает выделенной памяти ([`wallarm_ts_request_memory_limit
  `](../configure-parameters-ru.md#wallarm_ts_request_memory_limit)).  При превышении памяти также изменяется метрика [`tnt_errors`][anchor-tnt].

### Время хранения запросов в модуле постаналитики (в секундах)

Время, в течение которого модуль постаналитики хранит запросы. Значение зависит от количества выделенной памяти, размера и характера обрабатываемых HTTP‑запросов. Чем меньше значение, тем хуже работают алгоритмы обнаружения, которым необходим доступ к историческим данным. В результате злоумышленник может выполнять атаки перебора быстрее, оставаясь незамеченным. При этом будет получено меньше данных об истории поведения атакующего.

* **Величина:** `wallarm-tarantool/gauge-timeframe_size`
* **Значение величины:** 
    * оптимальное `>900`
    * предупреждающее `<900`
    * критичное `<300`
* **Рекомендации при отклонении значений:**
    * Увеличьте значение [`wallarm_ts_request_memory_limit`](../configure-parameters-ru.md#wallarm_ts_request_memory_limit).
    * Установите модуль постаналитики на отдельный сервер, как описано в [инструкции](../installation-postanalytics-ru.md).
