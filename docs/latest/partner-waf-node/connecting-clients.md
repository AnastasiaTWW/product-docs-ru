# Создание и привязка клиентов

## Требования

* Доступ к [аккаунту технического клиента](creating-partner-account.md) с ролью пользователя **Глобальный администратор** и отключенная двухфакторная аутентификация в Консоли управления Валарм
* [UUID партнера](creating-partner-account.md#шаг-2-получите-доступ-к-партнерскому-аккаунту-и-параметры-для-настройки-wafнод)

## Процедура создания и привязки клиента

Чтобы создать клиента и привязать его к партнерскому аккаунту, необходимо отправить запросы к Валарм API с собственного клиента или из интерфейса справочника API. В запросах к Валарм API необходимо передать параметры аутентификации:

* При отправке запроса из **интерфейса справочника API**, необходимо предварительно войти в аккаунт технического клиента с ролью пользователя **Глобальный администратор** и обновить справочник по ссылке:

    * https://apiconsole.eu1.wallarm.com/ для EU‑облака
    * https://apiconsole.ru1.wallarm.ru/ для RU‑облака
* При отправке запроса **с собственного клиента**, необходимо передать в запросе [UUID пользователя и секретный ключ](../api/overview.md#с-собственного-клиента)

### Шаг 1: Создайте клиента через Валарм API

При **создании клиента**, в системе Валарм создается аккаунт партнерского клиента, привязанный к партнерскому аккаунту.

1. Отправьте POST‑запрос на роут `/v1/objects/client/create` со следующими параметрами:

    Параметр | Описание | Часть запроса | Обязательность
    --------- | -------- | ------------- | ---------
    `name` | Название клиента. | Тело | Да
    `vuln_prefix` | Префикс уязвимости, который будет использоваться в системе Валарм для отслеживания и привязки к клиенту. Префикс должен состоять из четырех заглавных букв или цифр и соотноситься с названием клиента. Например, для клиента `Client` — `CLNT`. | Тело | Да
    `partner_uuid` | [UUID партнера](creating-partner-account.md#шаг-2-получите-доступ-к-партнерскому-аккаунту-и-параметры-для-настройки-wafнод). | Тело | Да
    `language` | Язык интерфейса Консоли управления Валарм для клиента: `en` или `ru`. По умолчанию — язык, который вы указали при переводе аккаунта в партнерский статус. | Тело | Нет
    `X-WallarmAPI-UUID` | [UUID пользователя](../api/overview.md#с-собственного-клиента). | Заголовок |Да, при отправке запроса с собственного клиента
    `X-WallarmAPI-Secret` | [Секретный ключ](../api/overview.md#с-собственного-клиента). | Заголовок | Да, при отправке запроса с собственного клиента

    ??? info "Показать пример запроса для отправки с собственного клиента"
        === "EU‑облако"
            ``` bash
            curl -v -X POST "https://api.wallarm.com/v1/objects/client/create" -H "X-WallarmAPI-UUID: YOUR_UUID" -H "X-WallarmAPI-Secret: YOUR_SECRET_KEY" -H "accept: application/json" -H "Content-Type: application/json" -d "{ \"name\": \"Client\", \"vuln_prefix\": \"CLNT\", \"partner_uuid\": \"YOUR_PARTNER_UUID\"}"
            ```
        === "RU‑облако"
            ```bash
            curl -v -X POST "https://api.wallarm.ru/v1/objects/client/create" -H "X-WallarmAPI-UUID: YOUR_UUID" -H "X-WallarmAPI-Secret: YOUR_SECRET_KEY" -H "accept: application/json" -H "Content-Type: application/json" -d "{ \"name\": \"Client\", \"vuln_prefix\": \"CLNT\", \"partner_uuid\": \"YOUR_PARTNER_UUID\"}"
            ```

2. Скопируйте значения параметров `id` и `partnerid` из ответа на запрос. Параметры будут использоваться при привязке клиента к партнерскому аккаунту.

При аутентификации [глобального пользователя](../user-guides/settings/users.md#роли-пользователей) партнера в Консоли управления, созданные клиенты отобразятся в селекторе клиентов в Консоли управления Валарм. Например, `Client 1` и `Client 2`:

![!Селектор клиентов в Консоли управления](../images/partner-waf-node/clients-selector-in-console.png)

### Шаг 2: Привяжите клиента к партнерскому аккаунту через Валарм API

При **привязке клиента**, для связи между приложением клиента и партнером задается специальный ID. При этом у одного клиента может быть несколько приложений и несколько ID соответственно. ID будет использоваться в настройках NGINX (`wallarm_instance`) для разделения трафика по приложениям клиентов.

1. Отправьте POST‑запрос на роут `/v2/partner/<partnerid>/partner_client` со следующими параметрами:

    Параметр | Описание | Часть запроса | Обязательность
    --------- | -------- | ------------- | ------
    `partnerid` | Значение `partnerid`, полученное после создания клиента. | Путь | Да
    `clientid` | ID клиента, полученный после создания клиента (`id`). | Тело | Да
    `id` | ID для связи между партнером и клиентом. Может быть произвольное целое положительное число. | Тело | Да
    `X-WallarmAPI-UUID` | [UUID пользователя](../api/overview.md#с-собственного-клиента). | Заголовок |Да, при отправке запроса с собственного клиента
    `X-WallarmAPI-Secret` | [Секретный ключ](../api/overview.md#с-собственного-клиента). | Заголовок | Да, при отправке запроса с собственного клиента

    ??? info "Показать пример запроса для отправки с собственного клиента"
        === "EU‑облако"
            ``` bash
            curl -v -X POST "https://api.wallarm.com/v2/partner/111/partner_client" -H "X-WallarmAPI-UUID: YOUR_UUID" -H "X-WallarmAPI-Secret: YOUR_SECRET_KEY" -H "accept: application/json" -H "Content-Type: application/json" -d "{ \"clientid\": 888, \"id\": \"13\"}"
            ```
        === "RU‑облако"
            ```bash
            curl -v -X POST "https://api.wallarm.ru/v2/partner/111/partner_client" -H "X-WallarmAPI-UUID: YOUR_UUID" -H "X-WallarmAPI-Secret: YOUR_SECRET_KEY" -H "accept: application/json" -H "Content-Type: application/json" -d "{ \"clientid\": 888, \"id\": \"14\"}"
            ```

2. Скопируйте и сохраните значение `id`, которое вы передали в запросе. Параметр будет использоваться в настройках NGINX (`wallarm_instance`) для разделения трафика нескольких клиентов.

Если вы настраиваете защиту нескольких приложений клиента, повторите вызов метода API с новым значением `id` для другого приложения.

Когда на ресурс клиента поступит трафик, созданные `id` отобразятся в Консоли управления Валарм → **Настройки** → **Приложения** в соответствующем аккаунте партнерского клиента.

## Предоставление клиентам доступа к Консоли управления

Вы можете предоставить своим клиентам доступ к их аккаунтам в Консоли управления. Клиенты смогут отслеживать заблокированные запросы, анализировать обнаруженные уязвимости и выполнять дополнительную настройку WAF‑нод через Консоль управления.

Чтобы предоставить клиенту доступ к аккаунту, перейдите к его аккаунту через селектор клиентов → секция **Настройки** → **Пользователи** и добавьте пользователей с необходимыми ролями. На уровне партнерского клиента настраиваются только обычные роли, которые дают доступ только к одному аккаунту партнерского клиента.

[Перейти к описанию ролей →](../user-guides/settings/users.md)
