[link-ip-blocking]:     ../admin-ru/configure-ip-blocking-ru.md
[doc-apps-link]:        settings/applications.md

[img-blacklist]:        ../images/user-guides/blacklist/blacklist.png
[img-blacklist-add]:        ../images/user-guides/blacklist/ip-blacklisting.png
[img-blacklist-change-time]: ../images/user-guides/blacklist/blacklist-contextual-change-time.png
[img-blacklist-unblock]: ../images/user-guides/blacklist/blacklist-contextual-unblock.png

# Использование черного списка

Валарм может блокировать большую часть вредоносного трафика на основе каждого запроса, в котором определяется вектор атаки. Однако для поведенческих атак, в которых каждый запрос является легитимным (например, попытки авторизоваться с парами имя пользователя и пароль), необходимо блокировать источник.

Валарм может блокировать ботов и такие поведенческие атаки, как злоупотребление приложением, атаки перебора и forced browsing, автоматическим добавлением IP‑адресов в черный список. Администраторы также могут вручную добавлять IP‑адреса и подсети в список заблокированных.

![!Черный список][img-blacklist]

В секции **Черный список** Личного кабинета вы можете:

* просмотреть список заблокированных адресов и причину блокировки;
* разблокировать любой IP‑адрес или задать время автоматической разблокировки;
* заблокировать IP‑адрес или подсеть.

!!! warning "Включите блокировку на WAF‑ноде"
    Для того, чтобы черные списки Валарм применились, их необходимо включить на WAF‑ноде:

    * [Инструкция для обычной WAF‑ноды][link-ip-blocking]
    * Чтобы включить черные списки для [партнерской WAF‑ноды](../partner-waf-node/overview.md), обратитесь в [техническую поддержку Валарм](mailto:support@wallarm.ru).

## Работа с активными блокировками

По умолчанию в секции **Черный список** открывается вкладка **Сейчас** с IP‑адресами, которые заблокированы на текущий момент.

Для каждого IP‑адреса отображаются следующие данные:

* **IP / Источник** — заблокированный IP‑адрес. Если в базе Валарм найдена дополнительнная информация об IP‑адресе, также отображаются следующие параметры:
    * Страна, в которой зарегистрирован IP‑адрес
    * Дата‑центры, которым принадлежит один или несколько IP‑адресов: **AWS** для Amazon, **GCP** для Google, **Azure** для Microsoft, **DC** для других дата‑центров
    * Тег **Tor**, если атака целиком или частично выполнена с узлов Tor
    * Тег **VPN**, если IP‑адрес принадлежит сети VPN
    * Тег **Public proxy** или **Web proxy**, если запрос отправлен с публичного прокси‑сервера или веб‑сервера
* **Причина** — причина блокировки IP‑адреса. Указывается при блокировке адреса вручную или генерируется автоматически для IP‑адресов, заблокированных Валарм.
* **Приложение** — приложение, на доступ к которому установлена блокировка.
* **Время блокировки**— дата и время блокировки.
* **Разблокировать** — временной период, после которого адрес разблокируется.

### Фильтрация заблокированных IP‑адресов

Вы можете отфильтровать список заблокированных IP‑адресов по параметрам:

* IP‑адрес, указанный в поле **Поиск по IP**
* [Приложение][doc-apps-link], на доступ к которому установлена блокировка

### Изменение времени блокировки

Чтобы изменить время блокировки IP‑адреса:

1. Выберите заблокированный IP‑адрес из списка.
2. Нажмите **Изменить время блокировки**.

    ![!Change blocking time][img-blacklist-change-time]
3. Выберите новую дату разблокировки адреса.

### Разблокировка IP‑адреса

Чтобы снять блокировку:

1. Выберите заблокированный IP‑адрес из списка.
2. Нажмите **Разблокировать**.

    ![!Разблокировка IP‑адреса][img-blacklist-unblock]

Также вы можете выбрать несколько IP‑адресов и разблокировать их по кнопке **Разблокировать** одновременно.

!!! warning "Повторная блокировка разблокированного IP‑адреса"
    После ручной разблокировки IP‑адреса, который был добавлен в черный список автоматически, повторная автоматическая блокировка произойдет по истечении половины времени предыдущей блокировки.

    Например:

    1. IP‑адрес был автоматически заблокирован на 1 час, так как с этого IP‑адреса было отправлено 4 разных вектора атаки за 3 часа (согласно [триггеру по умолчанию](triggers/trigger-examples.md#блокировка-ip-при-4-и-более-векторах-атак-за-3-часа-триггер-по-умолчанию)).
    2. Пользователь разблокировал IP‑адрес через Консоль управления Валарм.
    3. Если после разблокировки с IP‑адреса будут отправлены еще 4 разных вектора атаки менее чем за 30 минут, IP‑адрес не добавится в черный список.

## Работа с историей блокировок

Чтобы получить историю блокировок, в поле **Выберите дату** выберите период, за который необходимо получить данные. По умолчанию, история блокировок содержит события по всем IP‑адресам и приложениям. 

Для фильтрации истории используйте параметры:

* IP‑адрес, указанный в поле **Поиск по IP**
* [Приложение][doc-apps-link], на доступ к которому установлена блокировка

## Добавление IP‑адреса в черный список

!!! info "Добавление IP‑адреса в черный список на партнерской WAF‑ноде"
    Если в вашей инфраструктуре установлена [партнерская WAF‑нода](../partner-waf-node/overview.md), перед выполнением приведенных шагов необходимо переключиться на [аккаунт партнерского клиента](../partner-waf-node/overview.md#компоненты-партнерского-аккаунта), для которого блокируется IP‑адрес.

Для блокировки IP‑адреса:

1. Нажмите кнопку **Заблокировать**.
2. Введите значение в поле **IP, диапазон или подсеть**.
    
    Вы можете указать IP‑адрес с маской подсети. В списке заблокированных IP‑адресов отобразятся все адреса в подсети. Например: для адреса `a.b.c.0/24` в список добавятся 256 записей.
3. Выберите срок блокировки. Минимальный период блокировки — один час.
4. Укажите причину блокировки.
5. Нажмите **Заблокировать**.

!!! warning "Блокировка IP‑адреса для определенного приложения"
    По умолчанию запросы с IP‑адресов из черного списка блокируются к любому приложению. Селектор приложений в форме для добавления IP‑адреса в черный список не используется.

    Вы можете применить весь черный список IP‑адресов к определенному приложению. Для этого необходимо задать директиву [`wallarm_acl`](../admin-ru/configure-parameters-ru.md#wallarm_acl) в соответствующем блоке server или location в конфигурации NGINX. 

![!Черный список][img-blacklist-add]

## Экспорт адресов черного списка

Для экспорта списка заблокированных IP‑адресов или истории блокировок нажмите кнопку **Экспортировать**. 

Данные экспортируются в формате .csv с полями:

* **IP** — IP‑адрес.
* **Application** — идентификатор приложения, на доступ к которому установлена блокировка.
* **Type** — тип действия (**block** или **unblock**).
* **Time** — дата и время разблокировки.
* **Country** — страна, в которой зарегистрирован IP‑адрес.
* **Reason** — причина блокировки IP‑адреса, указанная при блокировке адреса вручную или сгенерированная автоматически на стороне Валарм.
