[link-check-attack]:        check-attack.md
[link-false-attack]:        false-attack.md

[img-analyze-attack]:       ../../images/user-guides/events/analyze-attack.png
[img-analyze-attack-raw]:   ../../images/user-guides/events/analyze-attack-raw.png
[img-current-attack]:       ../../images/user-guides/events/analyze-current-attack.png

[glossary-attack-vector]:   ../../glossary-ru.md#вектор-атаки

# Анализ атак

На вкладке *События* веб‑интерфейса размещается информация об атаках и инцидентах.

Валарм автоматически группирует связанные между собой вредоносные запросы в единую сущность&nbsp;— атаку.

## Просмотр атаки

Вы можете получить информацию обо всех атаках, проанализировав столбцы таблицы, описанные на странице [«Просмотр атак и инцидентов»][link-check-attack].

## Анализ запросов в атаке

Чтобы просмотреть запросы атаки:
1. Выберите атаку;
2. Нажмите на число в столбце *Запросы*.

Нажатие на число откроет список всех запросов в выбранной атаке.

![!Запросы в выбранной атаке][img-analyze-attack]

Информация о запросах отображается в следующих столбцах:

*   *Дата*&nbsp;— дата и время запроса;
*   *Вектор*&nbsp;— [вектор атаки][glossary-attack-vector]. Нажатие на значение вектора атаки выведет справку по данному типу атаки;
*   *Источник*&nbsp;— IP‑адрес, с которого пришел запрос. Нажатие на значение IP‑адреса добавит его в поисковую строку. Дополнительно может отображаться следующая информация:
    * Страна, в которой зарегистрирован IP‑адрес (если удалось найти в базе Валарм)
    * Дата‑центры, которым принадлежит один или несколько IP‑адресов: **AWS** для Amazon, **GCP** для Google, **Azure** для Microsoft, **DC** для других дата‑центров (если удалось найти в базе Валарм)
    * Тег **Tor**, если атака целиком или частично выполнена с узлов Tor (если удалось найти в базе Валарм)
    * Тег **VPN**, если IP‑адрес принадлежит сети VPN (если удалось найти в базе Валарм)
    * Тег **Public proxy** или **Web proxy**, если запрос отправлен с публичного прокси‑сервера или веб‑сервера (если удалось найти в базе Валарм)*   *Статус*&nbsp;— ответ защищаемого ресурса на запрос;
*   *Размер*&nbsp;— размер ответа защищаемого ресурса на запрос в байтах;
*   *Время*&nbsp;— время ответа защищаемого ресурса на запрос.

Если атака происходит в настоящее время, под графиком запросов будет отображена надпись «сейчас».

![!Атака, которая происходит в настоящее время][img-current-attack]

## Просмотр запроса в сыром формате

Вывод запроса в сыром формате позволяет проанализировать запрос наиболее детально. Чтобы открыть запрос в сыром формате:
1. Выберите атаку;
2. Нажмите на число в столбце *Запросы*;
3. Нажмите стрелку слева от даты запроса.

Веб-интерфейс отобразит запрос в сыром виде.

![!Просмотр запроса в сыром формате][img-analyze-attack-raw]

## Семплирование хитов

Одна атака может состоять из большого количества идентичных хитов (более 100). Хранение всех хитов может увеличивать нагрузку на Облако Валарм и требовать значительного количества времени для анализа и поиска атак через Консоль управления Валарм.

Чтобы оптимизировать хранение и анализ данных, к хитам применяется алгоритм семплирования:

* Из каждых 5 идентичных хитов, которые были обнаружены первыми в течение часа, в Облаке формируются выборки с полной информацией о хитах. Если несколько выборок являются частью одной атаки, они группируются (например, хиты в выборках отличаются только значением IP‑адреса отправителя).
* Остальные хиты не сохраняются в выборки, но их количество считается для каждой атаки и записывается в соответствующий параметр.

**Примеры**

* Во время атаки было отправлено 20 хитов: по 10 идентичных хитов с 2 разных IP‑адресов. В Облаке Валарм сохранится информация о 5 первых хитах с каждого IP‑адреса, количество других хитов запишется в отдельную переменную (10).
* Во время атаки было отправлено 10 хитов с разных IP‑адресов. В Облаке Валарм сохранится информация обо всех хитах.

**Включение алгоритма семплирования**

* Для [атак на проверку входных данных](../../about-wallarm-waf/protecting-against-attacks.md#атаки-на-проверку-входных-данных): алгоритм семплирования включается, если в вашем трафике обнаружен высокий процент атак.

    При включении алгоритма семплирования, все пользователи аккаунта вашей компании с [ролью **Администратор** и **Глобальный администратор**](../settings/users.md#роли-пользователей) получат соответствующее письмо на email. Письма отправляются с интервалом в 8 часов, если алгоритм семплирования включается/отключается из‑за изменения процента атак в трафике.
* Для всех [поведенческих атак](../../about-wallarm-waf/protecting-against-attacks.md#поведенческие-атаки): алгоритм семплирования включен по умолчанию.

Если семплирование хитов включено для вашего трафика, в секции **События** в Консоли управления Валарм отображается соответствующий статус, сохраненная выборка из хитов и количество остальных хитов. Например:

![!Выборка запросов в брутфорс-атаке](../../images/user-guides/events/bruteforce-dropped-hits.png)

## Демо‑видео

<div class="video-wrapper">
  <iframe width="1280" height="720" src="https://www.youtube.com/embed/spD3BnI6fq4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>
