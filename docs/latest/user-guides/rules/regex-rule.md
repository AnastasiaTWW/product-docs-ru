[link-regex]:       https://github.com/yandex/pire

[img-regex-example1]:       ../../images/user-guides/rules/regex-rule-1.png
[img-regex-example2]:       ../../images/user-guides/rules/regex-rule-2.png
[img-regex-id]:             ../../images/user-guides/rules/regex-id.png

# Пользовательские правила детекта

В некоторых случаях может быть полезно добавить сигнатуру для детектирования атак вручную или создать так называемый *виртуальный патч*. Валарм сам по себе не использует регулярные выражения для обнаружения атак, однако позволяет пользователям добавить дополнительные сигнатуры, основанные на регулярных выражениях.

## Добавление нового правила детекта

Для этого надо создать правило *Считать атакой на основе регулярного выражения* и заполнить поля:

*Regex*&nbsp;— регулярное выражение (сигнатура). Если значение указанного ниже параметра попадает под выражение, такой запрос детектируется как атака. Синтаксис и особенности регулярных выражений описаны в [инструкции по добавлению правил](add-rule.md#regex).

*Атака*&nbsp;— тип атаки, которая будет обнаружена при попадании значения параметра в запросе под регулярное выражение;

*Экспериментальный*&nbsp;— этот флаг позволяет безопасно проверить срабатывания регулярного выражения без блокировки запросов. Запросы не будут блокироваться даже при работе WAF‑ноды в режиме блокировки. Все срабатывания будут рассматриваться как обнаруженные экспериментальным методом и доступны в поиске по выражению `experimental attacks`;

*в этой части запроса*&nbsp;— определяет, в каком параметре запроса детектировать соответствующие атаки.


### Пример&nbsp;— блокировка всех заголовков с некорректным заголовком X‑Authentication

**Если** выполняются следующие условия:

* приложение доступно на домене example.com;
* приложение использует для аутентификации пользователей заголовок X‑Authentication;
* формат заголовка&nbsp;— 32 hex-символа.

**Тогда** для создания правила, запрещающего токены с неправильным форматом:

1. Зайдите во вкладку *Правила*;
1. Найдите ветку для `example.com/**/*.*` и нажмите *Добавить правило*;
1. Выберите *Считать атакой на основе регулярного выражения*;
1. Введите в поле *Regex* значение `[^0-9a-f]|^.{33,}$|^.{0,31}$`;
1. Выберите для *Атака* тип *Virtual patch*;
1. Выберите параметр *Header* и введите его значение `X‑AUTHENTICATION` после *в этой части запроса*;
1. Нажмите *Создать*.

![!Создание пользовательского правила детекта][img-regex-example1]


## Частичное отключение нового правила детекта

Если созданное правило необходимо частично отключить для отдельной ветки, то это можно сделать, создав правило *Игнорировать регулярные выражения* со следующими полями:

- *Regex ID*&nbsp;— идентификаторы ранее созданных регулярных выражений, которые необходимо игнорировать;
- *в этой части запроса*&nbsp;— параметр, для которого нужно установить отключение правила.

### Получение идентификатора регулярного выражения

Идентификаторы генерируются автоматически при создании регулярных выражений. Вы можете узнать идентификатор интересующего вас регулярного выражения, выполнив следующие шаги:
1. На вкладке *Правила* нажмите на кнопку *Все правила* и выберите *Считать атакой на основе регулярного выражения* из выпадающего списка;
1. Выберите ветку, на которую установлено интересующее регулярное выражение;
1. Выберите группу правил, в которой находится интересующее регулярное выражение;
1. Нажмите на строку с нужным регулярным выражением;
1. На появившейся справа панели в поле *Regex ID* находится искомый идентификатор регулярного выражения. Чтобы скопировать его, нажмите на кнопку справа от поля.

![!Получение идентификатора регулярного выражения][img-regex-id]

### Пример&nbsp;— разрешить неправильный заголовок X‑Authentication для отдельного URL

Допустим, у вас есть скрипт `example.com/test.php`, на котором вы хотите изменить формат токенов.

Для создания соответствующего правила:

1. Зайдите во вкладку *Правила*;
1. Найдите или создайте ветку для `example.com/test.php` и нажмите *Добавить правило*;
1. Выберите *Игнорировать регулярные выражения*;
1. Введите в поле *Regex ID* значение идентификатора правила, которое необходимо отключить;
1. Выберите параметр *Header* и введите его значение `X‑AUTHENTICATION` после *в этой части запроса*;
1. Нажмите *Создать*.

![!Отключение пользовательского правила детекта][img-regex-example2]
